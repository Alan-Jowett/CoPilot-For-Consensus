# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Copilot-for-Consensus contributors

name: Schema Validation Integration Tests

on:
  push:
    branches: [ main, feature/shared-events-sdk ]
    paths:
      - 'sdk/**'
      - 'documents/schemas/**'
      - 'infra/init/**'
      - 'docker-compose.yml'
      - '.github/workflows/schema-integration-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'sdk/**'
      - 'documents/schemas/**'
      - 'infra/init/**'

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  integration:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12', '3.13']
    
    services:
      mongodb:
        image: mongo:6.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: testpass
        options: >-
          --health-cmd "mongosh --host localhost:27017 -u admin -p testpass --authenticationDatabase admin --quiet --eval \"db.adminCommand('ping')\""
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ./sdk/copilot_events
        pip install pytest jsonschema pymongo

    - name: Install MongoDB Shell
      run: |
        wget -qO - https://www.mongodb.org/static/pgp/server-6.0.asc | sudo apt-key add -
        echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list
        sudo apt-get update
        sudo apt-get install -y mongodb-mongosh

    - name: Wait for MongoDB to be ready
      run: |
        timeout 60 bash -c 'until mongosh --host localhost:27017 -u admin -p testpass --authenticationDatabase admin --quiet --eval "db.adminCommand(\"ping\")" > /dev/null 2>&1; do echo "Waiting for MongoDB..."; sleep 2; done'
        echo "MongoDB is ready!"

    - name: Seed MongoDB with schemas
      run: |
        python << 'EOF'
        import json
        import os
        from pathlib import Path
        from pymongo import MongoClient

        # Connect to MongoDB
        uri = 'mongodb://admin:testpass@localhost:27017/copilot?authSource=admin'
        client = MongoClient(uri)
        db = client['copilot']
        coll = db['event_schemas']

        # Create index
        coll.create_index('name', unique=True)

        # Seed schemas
        events_dir = Path('documents/schemas/events')
        schema_files = list(events_dir.glob('*.json'))
        
        for schema_file in schema_files:
            with open(schema_file, 'r') as f:
                schema = json.load(f)
            
            name = schema_file.stem.replace('.schema', '')
            coll.update_one(
                {'name': name},
                {'$set': {'name': name, 'fileName': schema_file.name, 'schema': schema}},
                upsert=True
            )
        
        print(f'Seeded {len(schema_files)} event schemas')
        client.close()
        EOF

    - name: Run integration tests
      env:
        MONGO_URI: mongodb://admin:testpass@localhost:27017/copilot?authSource=admin
        MONGO_DB: copilot
        MONGO_COLLECTION: event_schemas
      run: |
        cd sdk/copilot_events
        pytest tests/ -v --tb=short -m integration --junit-xml=test-results-integration.xml

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results-${{ matrix.python-version }}
        path: sdk/copilot_events/test-results-integration.xml

    - name: Test Report
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: Integration Test Results (Python ${{ matrix.python-version }})
        path: sdk/copilot_events/test-results-integration.xml
        reporter: 'java-junit'

  docker-compose-integration:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Start containers
      run: |
        docker compose up -d documentdb db-init
        echo "Waiting for MongoDB initialization..."
        docker compose logs -f db-init &
        INIT_PID=$!
        timeout 60 docker compose exec -T documentdb bash -c 'until mongosh --host localhost -u admin -p PLEASE_CHANGE_ME --authenticationDatabase admin --eval "db.adminCommand(\"ping\")" > /dev/null 2>&1; do sleep 1; done'
        kill $INIT_PID 2>/dev/null || true

    - name: Install SDK and test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ./sdk/copilot_events
        pip install pytest jsonschema pymongo

    - name: Run integration tests against seeded Mongo
      env:
        MONGO_URI: mongodb://admin:PLEASE_CHANGE_ME@localhost:27017/copilot?authSource=admin
        MONGO_DB: copilot
        MONGO_COLLECTION: event_schemas
      run: |
        cd sdk/copilot_events
        pytest tests/test_mongo_schema_provider_integration.py -v --tb=short --junit-xml=test-results-docker.xml

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: docker-integration-test-results
        path: sdk/copilot_events/test-results-docker.xml

    - name: Test Report
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: Docker Compose Integration Test Results
        path: sdk/copilot_events/test-results-docker.xml
        reporter: 'java-junit'

    - name: Cleanup
      if: always()
      run: |
        docker compose down -v
