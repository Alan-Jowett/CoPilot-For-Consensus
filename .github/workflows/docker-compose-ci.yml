# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Copilot-for-Consensus contributors

name: Docker Compose CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository }}/

jobs:
  # Test docker-compose with cached images
  test-docker-compose:
    name: Test Docker Compose
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Free up disk space
      run: |
        echo "Disk space before cleanup:"
        df -h
        # Remove unnecessary software to free up ~10GB
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo docker system prune -af --volumes
        echo "Disk space after cleanup:"
        df -h

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Clean up any existing containers and volumes
      run: |
        # Stop and remove any existing containers and volumes from previous runs
        docker compose down -v || true
        # Also remove any dangling containers
        docker container prune -f || true

    - name: Validate docker-compose configuration
      run: docker compose config

    - name: Build services sequentially to avoid disk space issues
      run: |
        # Build services one at a time and prune between builds
        SERVICES="ingestion parsing chunking embedding orchestrator summarization reporting error-reporting"
        for service in $SERVICES; do
          echo "Building $service..."
          docker compose build $service
          # Prune dangling images to free space
          docker image prune -f
        done

    # Infrastructure Services
    - name: Start documentdb
      run: |
        docker compose up -d documentdb
        timeout 60s bash -c 'until docker compose ps documentdb --format "{{.Status}}" | grep -q "(healthy)"; do echo "Waiting for documentdb..."; sleep 3; done' || (docker compose logs documentdb --tail=50 && exit 1)

    - name: Start messagebus
      run: |
        docker compose up -d messagebus
        timeout 60s bash -c 'until docker compose ps messagebus --format "{{.Status}}" | grep -q "(healthy)"; do echo "Waiting for messagebus..."; sleep 3; done' || (docker compose logs messagebus --tail=50 && exit 1)

    - name: Start vectorstore
      run: |
        docker compose up -d vectorstore
        timeout 60s bash -c 'until docker compose ps vectorstore --format "{{.Status}}" | grep -q "(healthy)"; do echo "Waiting for vectorstore..."; sleep 3; done' || (docker compose logs vectorstore --tail=50 && exit 1)

    - name: Start ollama
      run: |
        docker compose up -d ollama
        timeout 60s bash -c 'until docker compose ps ollama --format "{{.Status}}" | grep -q "(healthy)"; do echo "Waiting for ollama..."; sleep 3; done' || (docker compose logs ollama --tail=50 && exit 1)

    - name: Start monitoring (Prometheus)
      run: |
        docker compose up -d monitoring
        timeout 60s bash -c 'until docker compose ps monitoring --format "{{.Status}}" | grep -q "(healthy)"; do echo "Waiting for monitoring..."; sleep 3; done' || (docker compose logs monitoring --tail=50 && exit 1)

    - name: Start pushgateway
      run: |
        docker compose up -d pushgateway
        timeout 60s bash -c 'until docker compose ps pushgateway --format "{{.Status}}" | grep -q "(healthy)"; do echo "Waiting for pushgateway..."; sleep 3; done' || (docker compose logs pushgateway --tail=50 && exit 1)

    - name: Start loki
      run: |
        docker compose up -d loki
        timeout 30s bash -c 'until docker compose ps loki --format "{{.Status}}" | grep -q "(healthy)"; do echo "Waiting for loki..."; sleep 3; done' || (docker compose logs loki --tail=50 && exit 1)

    - name: Start grafana
      run: |
        docker compose up -d grafana
        timeout 90s bash -c 'until docker compose ps grafana --format "{{.Status}}" | grep -q "(healthy)"; do echo "Waiting for grafana..."; sleep 3; done' || (docker compose logs grafana --tail=50 && exit 1)

    - name: Start promtail
      run: |
        docker compose up -d promtail
        timeout 60s bash -c 'until docker compose ps promtail --format "{{.Status}}" | grep -q "(healthy)"; do echo "Waiting for promtail..."; sleep 3; done' || (docker compose logs promtail --tail=50 && exit 1)

    # Validator Services (one-shot containers)
    - name: Run db-init
      run: |
        docker compose up -d db-init
        docker compose wait db-init || (docker compose logs db-init && exit 1)
        [ $(docker compose ps db-init --format "{{.ExitCode}}") = "0" ] || (docker compose logs db-init && exit 1)
        docker compose logs db-init --tail=20

    - name: Run db-validate
      run: |
        docker compose up -d db-validate
        docker compose wait db-validate || (docker compose logs db-validate && exit 1)
        [ $(docker compose ps db-validate --format "{{.ExitCode}}") = "0" ] || (docker compose logs db-validate && exit 1)
        docker compose logs db-validate --tail=20

    - name: Run vectorstore-validate
      run: |
        docker compose up -d vectorstore-validate
        docker compose wait vectorstore-validate || (docker compose logs vectorstore-validate && exit 1)
        [ $(docker compose ps vectorstore-validate --format "{{.ExitCode}}") = "0" ] || (docker compose logs vectorstore-validate && exit 1)
        docker compose logs vectorstore-validate --tail=20

    - name: Run ollama-validate
      run: |
        docker compose up -d ollama-validate
        docker compose wait ollama-validate || (docker compose logs ollama-validate && exit 1)
        [ $(docker compose ps ollama-validate --format "{{.ExitCode}}") = "0" ] || (docker compose logs ollama-validate && exit 1)
        docker compose logs ollama-validate --tail=20

    # Application Services
    - name: Start parsing
      run: |
        docker compose up -d parsing
        timeout 120s bash -c 'until docker compose ps parsing --format "{{.Status}}" | grep -q "(healthy)"; do echo "Waiting for parsing..."; sleep 3; done' || (docker compose logs parsing --tail=50 && exit 1)

    - name: Start chunking
      run: |
        docker compose up -d chunking
        timeout 120s bash -c 'until docker compose ps chunking --format "{{.Status}}" | grep -q "(healthy)"; do echo "Waiting for chunking..."; sleep 3; done' || (docker compose logs chunking --tail=50 && exit 1)

    - name: Start embedding
      run: |
        docker compose up -d embedding
        timeout 120s bash -c 'until docker compose ps embedding --format "{{.Status}}" | grep -q "(healthy)"; do echo "Waiting for embedding..."; sleep 3; done' || (docker compose logs embedding --tail=50 && exit 1)

    - name: Start orchestrator
      run: |
        docker compose up -d orchestrator
        timeout 120s bash -c 'until docker compose ps orchestrator --format "{{.Status}}" | grep -q "(healthy)"; do echo "Waiting for orchestrator..."; sleep 3; done' || (docker compose logs orchestrator --tail=50 && exit 1)

    - name: Start summarization
      run: |
        docker compose up -d summarization
        timeout 120s bash -c 'until docker compose ps summarization --format "{{.Status}}" | grep -q "(healthy)"; do echo "Waiting for summarization..."; sleep 3; done' || (docker compose logs summarization --tail=50 && exit 1)

    - name: Start reporting
      run: |
        docker compose up -d reporting
        timeout 120s bash -c 'until docker compose ps reporting --format "{{.Status}}" | grep -q "(healthy)"; do echo "Waiting for reporting..."; sleep 3; done' || (docker compose logs reporting --tail=50 && exit 1)

    - name: Start error-reporting
      run: |
        docker compose up -d error-reporting
        timeout 120s bash -c 'until docker compose ps error-reporting --format "{{.Status}}" | grep -q "(healthy)"; do echo "Waiting for error-reporting..."; sleep 3; done' || (docker compose logs error-reporting --tail=50 && exit 1)

    - name: Start ingestion
      run: |
        docker compose up -d ingestion
        timeout 120s bash -c 'until docker compose ps ingestion --format "{{.Status}}" | grep -q "(healthy)"; do echo "Waiting for ingestion..."; sleep 3; done' || (docker compose logs ingestion --tail=50 && exit 1)

    - name: Check service status
      run: docker compose ps

    - name: Run ingestion service
      run: |
        echo "Starting ingestion service..."
        docker compose run --rm ingestion

    - name: Check ingestion service exit code
      run: |
        echo "Verifying ingestion completed successfully..."
        # The previous step will fail if exit code is non-zero
        echo "✓ Ingestion service completed successfully"

    - name: View ingestion logs
      if: always()
      run: docker compose logs ingestion

    - name: Test reporting service health endpoint
      run: |
        echo "Testing reporting service..."
        max_attempts=10
        attempt=1
        while [ $attempt -le $max_attempts ]; do
          if curl -f http://localhost:8080/ 2>/dev/null; then
            echo "✓ Reporting service is healthy"
            exit 0
          fi
          echo "Attempt $attempt/$max_attempts: Reporting service not responding yet..."
          sleep 3
          attempt=$((attempt + 1))
        done
        echo "❌ Reporting service failed to respond after $max_attempts attempts"
        docker compose logs reporting --tail=50
        exit 1

    - name: Test reporting API endpoint
      run: |
        echo "Testing reports API..."
        curl -f http://localhost:8080/api/reports || (docker compose logs reporting --tail=50 && exit 1)

    - name: Test error-reporting service health endpoint
      run: |
        echo "Testing error-reporting service..."
        max_attempts=10
        attempt=1
        while [ $attempt -le $max_attempts ]; do
          if curl -f http://localhost:8081/ 2>/dev/null; then
            echo "✓ Error-reporting service is healthy"
            exit 0
          fi
          echo "Attempt $attempt/$max_attempts: Error-reporting service not responding yet..."
          sleep 3
          attempt=$((attempt + 1))
        done
        echo "❌ Error-reporting service failed to respond after $max_attempts attempts"
        docker compose logs error-reporting --tail=50
        exit 1

    - name: Test error-reporting UI endpoint
      run: |
        echo "Testing error-reporting UI..."
        curl -f http://localhost:8081/ui || (docker compose logs error-reporting --tail=50 && exit 1)

    - name: Test error-reporting API
      run: |
        echo "Testing error-reporting stats API..."
        curl -f http://localhost:8081/api/stats || (docker compose logs error-reporting --tail=50 && exit 1)

    - name: Test Grafana health endpoint
      run: |
        echo "Testing Grafana..."
        curl -f http://localhost:3000/api/health || exit 1

    - name: Test Prometheus health endpoint
      run: |
        echo "Testing Prometheus..."
        curl -f http://localhost:9090/-/healthy || exit 1

    - name: Test Loki health endpoint
      run: |
        echo "Testing Loki..."
        max_attempts=30
        attempt=1
        while [ $attempt -le $max_attempts ]; do
          if curl -f http://localhost:3100/ready 2>/dev/null; then
            echo "Loki is ready"
            exit 0
          fi
          echo "Attempt $attempt/$max_attempts: Loki not ready yet, waiting..."
          sleep 5
          attempt=$((attempt + 1))
        done
        echo "Loki failed to become ready after $max_attempts attempts"
        exit 1

    - name: View service logs
      if: always()
      run: docker compose logs --tail=50

    - name: Stop all services
      if: always()
      run: docker compose down

    - name: Verify clean shutdown
      if: always()
      run: |
        echo "Verifying all containers stopped..."
        if [ "$(docker compose ps -q | wc -l)" -eq 0 ]; then
          echo "✓ All services stopped successfully"
        else
          echo "✗ Some services failed to stop"
          docker compose ps
          exit 1
        fi
