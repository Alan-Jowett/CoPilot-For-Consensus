# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Copilot-for-Consensus contributors

name: Docker Compose CI

on:
  push:
    branches: [ main, docker_compose ]
  pull_request:
    branches: [ main ]

jobs:
  test-docker-compose:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Validate docker-compose configuration
      run: docker compose config

    - name: Build all services
      run: docker compose build

    - name: Start all services
      run: docker compose up -d

    - name: Wait for services to be healthy
      run: |
        echo "Waiting for services to start..."
        sleep 30

    - name: Check service status
      run: docker compose ps

    - name: Verify Mongo collections and indexes
      run: |
        set -euo pipefail
        USERNAME=${MONGO_INITDB_ROOT_USERNAME:-root}
        PASSWORD=${MONGO_INITDB_ROOT_PASSWORD:-example}
        DB_NAME=${MONGO_APP_DB:-copilot}

        docker compose exec -T \
          -e MONGO_APP_DB=$DB_NAME \
          documentdb \
          mongosh "mongodb://${USERNAME}:${PASSWORD}@documentdb:27017/admin" --eval "$(cat <<'JS'
            const dbName = process.env.MONGO_APP_DB || 'copilot';
            const db = db.getSiblingDB(dbName);
            const expected = {
              archives: ['archive_id_unique','source_idx','ingestion_date_idx','status_idx'],
              messages: ['message_id_unique','archive_id_idx','thread_id_idx','date_idx','in_reply_to_idx','draft_mentions_idx','created_at_idx'],
              chunks: ['chunk_id_unique','message_id_idx','thread_id_idx','created_at_idx','embedding_generated_idx'],
              threads: ['thread_id_unique','archive_id_idx','first_message_date_idx','last_message_date_idx','draft_mentions_idx','has_consensus_idx','summary_id_idx','created_at_idx'],
              summaries: ['summary_id_unique','thread_id_idx','summary_type_idx','generated_at_idx']
            };

            const collections = db.getCollectionNames();
            for (const [name, indexes] of Object.entries(expected)) {
              if (!collections.includes(name)) {
                throw new Error(`Missing collection: ${name}`);
              }

              const collInfo = db.getCollectionInfos({ name })[0] || {};
              if (!collInfo.options || !collInfo.options.validator) {
                throw new Error(`Missing validator on collection: ${name}`);
              }

              const present = db.getCollection(name).getIndexes().map((i) => i.name);
              indexes.forEach((idx) => {
                if (!present.includes(idx)) {
                  throw new Error(`Missing index '${idx}' on collection '${name}'`);
                }
              });
            }

            print('Mongo collections, validators, and indexes validated');
          JS
          )"

    - name: Test reporting service health endpoint
      run: |
        echo "Testing reporting service..."
        curl -f http://localhost:8080/ || exit 1

    - name: Test reporting API endpoint
      run: |
        echo "Testing reports API..."
        curl -f http://localhost:8080/api/reports || exit 1

    - name: View service logs
      if: always()
      run: docker compose logs --tail=50

    - name: Stop all services
      if: always()
      run: docker compose down

    - name: Verify clean shutdown
      if: always()
      run: |
        echo "Verifying all containers stopped..."
        if [ "$(docker compose ps -q | wc -l)" -eq 0 ]; then
          echo "✓ All services stopped successfully"
        else
          echo "✗ Some services failed to stop"
          docker compose ps
          exit 1
        fi
