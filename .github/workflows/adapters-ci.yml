# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Copilot-for-Consensus contributors

name: Adapters CI (Changed-Only)

on:
  push:
    branches: [ main ]
    paths:
      - 'adapters/**'
      - '.github/workflows/adapters-ci.yml'
      - '.github/workflows/adapter-reusable-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'adapters/**'
      - '.github/workflows/adapters-ci.yml'
      - '.github/workflows/adapter-reusable-ci.yml'

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}
      has_changes: ${{ steps.build-matrix.outputs.has_changes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Detect changed adapters
        id: filter
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            copilot_auth:
              - 'adapters/copilot_auth/**'
            copilot_config:
              - 'adapters/copilot_config/**'
            copilot_events:
              - 'adapters/copilot_events/**'
            copilot_logging:
              - 'adapters/copilot_logging/**'
            copilot_metrics:
              - 'adapters/copilot_metrics/**'
            copilot_reporting:
              - 'adapters/copilot_reporting/**'
            copilot_storage:
              - 'adapters/copilot_storage/**'
            copilot_embedding:
              - 'adapters/copilot_embedding/**'
            copilot_chunking:
              - 'adapters/copilot_chunking/**'
            copilot_consensus:
              - 'adapters/copilot_consensus/**'
            copilot_schema_validation:
              - 'adapters/copilot_schema_validation/**'

      - name: Build matrix JSON
        id: build-matrix
        run: |
          set -euo pipefail
          changed_list="[]"
          append_if_changed() {
            id="$1"; path="$2"; pkg="$3"; changed_flag="$4"
            if [ "$changed_flag" = 'true' ]; then
              entry="{\"adapter_id\":\"$id\",\"adapter_path\":\"$path\",\"package_name\":\"$pkg\"}"
              if [ "$changed_list" = "[]" ]; then
                changed_list="[$entry]"
              else
                changed_list="${changed_list%,}] , $entry]"
              fi
            fi
          }

          append_if_changed copilot_auth adapters/copilot_auth copilot_auth "${{ steps.filter.outputs.copilot_auth }}"
          append_if_changed copilot_config adapters/copilot_config copilot_config "${{ steps.filter.outputs.copilot_config }}"
          append_if_changed copilot_events adapters/copilot_events copilot_events "${{ steps.filter.outputs.copilot_events }}"
          append_if_changed copilot_logging adapters/copilot_logging copilot_logging "${{ steps.filter.outputs.copilot_logging }}"
          append_if_changed copilot_metrics adapters/copilot_metrics copilot_metrics "${{ steps.filter.outputs.copilot_metrics }}"
          append_if_changed copilot_reporting adapters/copilot_reporting copilot_reporting "${{ steps.filter.outputs.copilot_reporting }}"
          append_if_changed copilot_storage adapters/copilot_storage copilot_storage "${{ steps.filter.outputs.copilot_storage }}"
          append_if_changed copilot_embedding adapters/copilot_embedding copilot_embedding "${{ steps.filter.outputs.copilot_embedding }}"
          append_if_changed copilot_chunking adapters/copilot_chunking copilot_chunking "${{ steps.filter.outputs.copilot_chunking }}"
          append_if_changed copilot_consensus adapters/copilot_consensus copilot_consensus "${{ steps.filter.outputs.copilot_consensus }}"
          append_if_changed copilot_schema_validation adapters/copilot_schema_validation copilot_schema_validation "${{ steps.filter.outputs.copilot_schema_validation }}"

          echo "matrix={\"include\":$changed_list}" >> $GITHUB_OUTPUT
          if [ "$changed_list" != "[]" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

  run-adapter-ci:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.has_changes == 'true' }}
    uses: ./.github/workflows/adapter-reusable-ci.yml
    strategy:
      matrix: ${{ fromJSON(needs.detect-changes.outputs.matrix) }}
    with:
      adapter_id: ${{ matrix.adapter_id }}
      adapter_path: ${{ matrix.adapter_path }}
      package_name: ${{ matrix.package_name }}
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
