# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Copilot-for-Consensus contributors

name: Adapters CI (Changed-Only)

on:
  push:
    branches: [ main ]
    paths:
      - 'adapters/**'
      - '.github/workflows/adapters-ci.yml'
      - '.github/workflows/adapter-reusable-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'adapters/**'
      - '.github/workflows/adapters-ci.yml'
      - '.github/workflows/adapter-reusable-ci.yml'

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      copilot_auth: ${{ steps.filter.outputs.copilot_auth }}
      copilot_config: ${{ steps.filter.outputs.copilot_config }}
      copilot_events: ${{ steps.filter.outputs.copilot_events }}
      copilot_logging: ${{ steps.filter.outputs.copilot_logging }}
      copilot_metrics: ${{ steps.filter.outputs.copilot_metrics }}
      copilot_reporting: ${{ steps.filter.outputs.copilot_reporting }}
      copilot_storage: ${{ steps.filter.outputs.copilot_storage }}
      copilot_embedding: ${{ steps.filter.outputs.copilot_embedding }}
      copilot_chunking: ${{ steps.filter.outputs.copilot_chunking }}
      copilot_consensus: ${{ steps.filter.outputs.copilot_consensus }}
      copilot_schema_validation: ${{ steps.filter.outputs.copilot_schema_validation }}
      copilot_vectorstore: ${{ steps.filter.outputs.copilot_vectorstore }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Detect changed adapters
        id: filter
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            copilot_auth:
              - 'adapters/copilot_auth/**'
            copilot_config:
              - 'adapters/copilot_config/**'
            copilot_events:
              - 'adapters/copilot_events/**'
            copilot_logging:
              - 'adapters/copilot_logging/**'
            copilot_metrics:
              - 'adapters/copilot_metrics/**'
            copilot_reporting:
              - 'adapters/copilot_reporting/**'
            copilot_storage:
              - 'adapters/copilot_storage/**'
            copilot_embedding:
              - 'adapters/copilot_embedding/**'
            copilot_chunking:
              - 'adapters/copilot_chunking/**'
            copilot_consensus:
              - 'adapters/copilot_consensus/**'
            copilot_schema_validation:
              - 'adapters/copilot_schema_validation/**'

      - name: Build matrix JSON
        id: build-matrix
        run: |
          set -euo pipefail
          changed_list="[]"
          append_if_changed() {
            id="$1"; path="$2"; pkg="$3"; changed_flag="$4"
            if [ "$changed_flag" = 'true' ]; then
              entry="{\"adapter_id\":\"$id\",\"adapter_path\":\"$path\",\"package_name\":\"$pkg\"}"
              if [ "$changed_list" = "[]" ]; then
                changed_list="[$entry]"
              else
                changed_list="${changed_list%,}] , $entry]"
              fi
            fi
          }

          append_if_changed copilot_auth adapters/copilot_auth copilot_auth "${{ steps.filter.outputs.copilot_auth }}"
          append_if_changed copilot_config adapters/copilot_config copilot_config "${{ steps.filter.outputs.copilot_config }}"
          append_if_changed copilot_events adapters/copilot_events copilot_events "${{ steps.filter.outputs.copilot_events }}"
          append_if_changed copilot_logging adapters/copilot_logging copilot_logging "${{ steps.filter.outputs.copilot_logging }}"
          append_if_changed copilot_metrics adapters/copilot_metrics copilot_metrics "${{ steps.filter.outputs.copilot_metrics }}"
          append_if_changed copilot_reporting adapters/copilot_reporting copilot_reporting "${{ steps.filter.outputs.copilot_reporting }}"
          append_if_changed copilot_storage adapters/copilot_storage copilot_storage "${{ steps.filter.outputs.copilot_storage }}"
          append_if_changed copilot_embedding adapters/copilot_embedding copilot_embedding "${{ steps.filter.outputs.copilot_embedding }}"
          append_if_changed copilot_chunking adapters/copilot_chunking copilot_chunking "${{ steps.filter.outputs.copilot_chunking }}"
          append_if_changed copilot_consensus adapters/copilot_consensus copilot_consensus "${{ steps.filter.outputs.copilot_consensus }}"
          append_if_changed copilot_schema_validation adapters/copilot_schema_validation copilot_schema_validation "${{ steps.filter.outputs.copilot_schema_validation }}"

          echo "matrix={\"include\":$changed_list}" >> $GITHUB_OUTPUT
          if [ "$changed_list" != "[]" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
                  copilot_vectorstore:
                    - 'adapters/copilot_vectorstore/**'

        auth-ci:
          needs: detect-changes
          if: ${{ needs.detect-changes.outputs.copilot_auth == 'true' }}
          uses: ./.github/workflows/adapter-reusable-ci.yml
          with:
            adapter_id: copilot_auth
            adapter_path: adapters/copilot_auth
            package_name: copilot_auth

        config-ci:
          needs: detect-changes
          if: ${{ needs.detect-changes.outputs.copilot_config == 'true' }}
          uses: ./.github/workflows/adapter-reusable-ci.yml
          with:
            adapter_id: copilot_config
            adapter_path: adapters/copilot_config
            package_name: copilot_config

        events-ci:
          needs: detect-changes
          if: ${{ needs.detect-changes.outputs.copilot_events == 'true' }}
          uses: ./.github/workflows/adapter-reusable-ci.yml
          with:
            adapter_id: copilot_events
            adapter_path: adapters/copilot_events
            package_name: copilot_events

        logging-ci:
          needs: detect-changes
          if: ${{ needs.detect-changes.outputs.copilot_logging == 'true' }}
          uses: ./.github/workflows/adapter-reusable-ci.yml
          with:
            adapter_id: copilot_logging
            adapter_path: adapters/copilot_logging
            package_name: copilot_logging

        metrics-ci:
          needs: detect-changes
          if: ${{ needs.detect-changes.outputs.copilot_metrics == 'true' }}
          uses: ./.github/workflows/adapter-reusable-ci.yml
          with:
            adapter_id: copilot_metrics
            adapter_path: adapters/copilot_metrics
            package_name: copilot_metrics

        reporting-ci:
          needs: detect-changes
          if: ${{ needs.detect-changes.outputs.copilot_reporting == 'true' }}
          uses: ./.github/workflows/adapter-reusable-ci.yml
          with:
            adapter_id: copilot_reporting
            adapter_path: adapters/copilot_reporting
            package_name: copilot_reporting

        storage-ci:
          needs: detect-changes
          if: ${{ needs.detect-changes.outputs.copilot_storage == 'true' }}
          uses: ./.github/workflows/adapter-reusable-ci.yml
          with:
            adapter_id: copilot_storage
            adapter_path: adapters/copilot_storage
            package_name: copilot_storage

        embedding-ci:
          needs: detect-changes
          if: ${{ needs.detect-changes.outputs.copilot_embedding == 'true' }}
          uses: ./.github/workflows/adapter-reusable-ci.yml
          with:
            adapter_id: copilot_embedding
            adapter_path: adapters/copilot_embedding
            package_name: copilot_embedding

        chunking-ci:
          needs: detect-changes
          if: ${{ needs.detect-changes.outputs.copilot_chunking == 'true' }}
          uses: ./.github/workflows/adapter-reusable-ci.yml
          with:
            adapter_id: copilot_chunking
            adapter_path: adapters/copilot_chunking
            package_name: copilot_chunking

        consensus-ci:
          needs: detect-changes
          if: ${{ needs.detect-changes.outputs.copilot_consensus == 'true' }}
          uses: ./.github/workflows/adapter-reusable-ci.yml
          with:
            adapter_id: copilot_consensus
            adapter_path: adapters/copilot_consensus
            package_name: copilot_consensus

        schema-validation-ci:
          needs: detect-changes
          if: ${{ needs.detect-changes.outputs.copilot_schema_validation == 'true' }}
          uses: ./.github/workflows/adapter-reusable-ci.yml
          with:
            adapter_id: copilot_schema_validation
            adapter_path: adapters/copilot_schema_validation
            package_name: copilot_schema_validation

        vectorstore-ci:
          needs: detect-changes
          if: ${{ needs.detect-changes.outputs.copilot_vectorstore == 'true' }}
          uses: ./.github/workflows/adapter-reusable-ci.yml
          with:
            adapter_id: copilot_vectorstore
            adapter_path: adapters/copilot_vectorstore
            package_name: copilot_vectorstore
