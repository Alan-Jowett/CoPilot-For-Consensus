# SPDX-License-Identifier: MIT

name: Adapters CI (Changed-Only)

on:
  push:
    branches: [ main ]
    paths:
      - 'adapters/**'
      - '.github/workflows/adapters-ci.yml'
      - '.github/workflows/adapter-reusable-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'adapters/**'
      - '.github/workflows/adapters-ci.yml'
      - '.github/workflows/adapter-reusable-ci.yml'

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.filter.outputs.changed }}
      matrix: ${{ steps.build-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Detect changed adapters
        id: filter
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            copilot_auth:
              - 'adapters/copilot_auth/**'
            copilot_config:
              - 'adapters/copilot_config/**'
            copilot_events:
              - 'adapters/copilot_events/**'
            copilot_logging:
              - 'adapters/copilot_logging/**'
            copilot_metrics:
              - 'adapters/copilot_metrics/**'
            copilot_reporting:
              - 'adapters/copilot_reporting/**'
            copilot_storage:
              - 'adapters/copilot_storage/**'
            copilot_embedding:
              - 'adapters/copilot_embedding/**'
            copilot_chunking:
              - 'adapters/copilot_chunking/**'
            copilot_consensus:
              - 'adapters/copilot_consensus/**'
            copilot_schema_validation:
              - 'adapters/copilot_schema_validation/**'

      - name: Build matrix JSON
        id: build-matrix
        run: |
          set -euo pipefail
          changed_list=()
          add_entry() {
            id="$1"; path="$2"; pkg="$3"
            changed_flag="${{ steps.filter.outputs.$1 }}"
            if [ "$changed_flag" = 'true' ]; then
              changed_list+=("{\"adapter_id\":\"$id\",\"adapter_path\":\"$path\",\"package_name\":\"$pkg\"}")
            fi
          }
          add_entry copilot_auth adapters/copilot_auth copilot_auth
          add_entry copilot_config adapters/copilot_config copilot_config
          add_entry copilot_events adapters/copilot_events copilot_events
          add_entry copilot_logging adapters/copilot_logging copilot_logging
          add_entry copilot_metrics adapters/copilot_metrics copilot_metrics
          add_entry copilot_reporting adapters/copilot_reporting copilot_reporting
          add_entry copilot_storage adapters/copilot_storage copilot_storage
          add_entry copilot_embedding adapters/copilot_embedding copilot_embedding
          add_entry copilot_chunking adapters/copilot_chunking copilot_chunking
          add_entry copilot_consensus adapters/copilot_consensus copilot_consensus
          add_entry copilot_schema_validation adapters/copilot_schema_validation copilot_schema_validation

          if [ ${#changed_list[@]} -eq 0 ]; then
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
          else
            json="{\"include\":[${changed_list[*]}]}"
            echo "matrix=$json" >> $GITHUB_OUTPUT
          fi

  run-adapter-ci:
    needs: detect-changes
    if: ${{ fromJSON(needs.detect-changes.outputs.matrix).include != null && length(fromJSON(needs.detect-changes.outputs.matrix).include) > 0 }}
    uses: ./.github/workflows/adapter-reusable-ci.yml
    strategy:
      matrix: ${{ fromJSON(needs.detect-changes.outputs.matrix) }}
    with:
      adapter_id: ${{ matrix.adapter_id }}
      adapter_path: ${{ matrix.adapter_path }}
      package_name: ${{ matrix.package_name }}
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
