# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Copilot-for-Consensus contributors

name: Bicep Template Validation

on:
  pull_request:
    paths:
      - 'infra/azure/**'
  push:
    branches:
      - main
    paths:
      - 'infra/azure/**'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  pull-requests: write

concurrency:
  # Cancel any in-progress instance of this workflow for the same PR.
  # Allow running concurrently with any commits on any other branch.
  group: bicep-validate-${{ github.event.pull_request.number || github.sha || github.ref }}
  cancel-in-progress: true

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  VALIDATION_RESOURCE_GROUP: copilot-bicep-validation-rg

jobs:
  bicep-lint:
    name: Bicep Lint & Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az --version

      - name: Bicep build & lint - main.bicep
        run: |
          cd infra/azure
          az bicep build --file main.bicep
          echo "âœ“ main.bicep syntax valid"

      - name: Bicep build & lint - core.bicep
        run: |
          cd infra/azure
          az bicep build --file core.bicep
          echo "âœ“ core.bicep syntax valid"

      - name: Bicep lint - main.bicep
        run: |
          cd infra/azure
          az bicep lint --file main.bicep
          echo "âœ“ main.bicep linting complete"

      - name: Bicep lint - core.bicep
        run: |
          cd infra/azure
          az bicep lint --file core.bicep
          echo "âœ“ core.bicep linting complete"

      - name: Bicep lint - identities.bicep
        run: |
          cd infra/azure
          az bicep lint --file modules/identities.bicep
          echo "âœ“ identities.bicep linting complete"

      - name: Bicep lint - keyvault.bicep
        run: |
          cd infra/azure
          az bicep lint --file modules/keyvault.bicep
          echo "âœ“ keyvault.bicep linting complete"

      - name: Bicep lint - keyvault-rbac.bicep
        run: |
          cd infra/azure
          az bicep lint --file modules/keyvault-rbac.bicep
          echo "âœ“ keyvault-rbac.bicep linting complete"

  validate-template:
    name: ARM Template Validation
    runs-on: ubuntu-latest
    needs: bicep-lint
    outputs:
      whatif-status: ${{ steps.whatif-step.outputs.status }}
    steps:
      - uses: actions/checkout@v6

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          enable-AzPSSession: false

      - name: Ensure validation resource group exists
        run: |
          RG_NAME="${{ env.VALIDATION_RESOURCE_GROUP }}"
          if ! az group show --name "$RG_NAME" >/dev/null 2>&1; then
            echo "âŒ Validation resource group '$RG_NAME' not found."
            echo "Please create it once with:"
            echo "  az group create --name $RG_NAME --location westus"
            exit 1
          fi
          echo "âœ“ Using validation RG: $RG_NAME"

      - name: Validate core.bicep template
        run: |
          cd infra/azure
          az deployment group validate \
            --resource-group ${{ env.VALIDATION_RESOURCE_GROUP }} \
            --template-file core.bicep \
            --parameters parameters.core.dev.json \
            --query "validationLevel" -o tsv
          echo "âœ“ Core template validation passed"

      - name: Run what-if analysis (core-dev)
        id: whatif-step
        continue-on-error: true
        run: |
          cd infra/azure

          # Run what-if and capture exit code
          set +e
          az deployment group what-if \
            --resource-group ${{ env.VALIDATION_RESOURCE_GROUP }} \
            --template-file core.bicep \
            --parameters parameters.core.dev.json \
            --output json > what-if-output.json
          WHATIF_EXIT_CODE=$?
          set -e

          # Set output based on exit code
          if [ $WHATIF_EXIT_CODE -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ“ What-if analysis completed successfully"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âš ï¸ What-if analysis failed with exit code: $WHATIF_EXIT_CODE"
          fi

      - name: Parse and comment what-if results
        if: github.event_name == 'pull_request'
        run: |
          # Extract resource changes from what-if output
          cd infra/azure
          if [ -f what-if-output.json ]; then
            cat > /tmp/parse-whatif.py << 'PYTHON'
          import json
          import sys

          try:
              with open('what-if-output.json') as f:
                  data = json.load(f)
          except (json.JSONDecodeError, FileNotFoundError, IOError) as e:
              print(f"Error reading what-if output: {e}")
              sys.exit(0)

          # Azure CLI what-if output has 'changes' array at top level
          changes = data.get('changes', [])
          if not changes:
              print("No resource changes detected")
              sys.exit(0)

          # Categorize changes by type
          creates = [c for c in changes if c.get('changeType') == 'Create']
          modifies = [c for c in changes if c.get('changeType') == 'Modify']
          deletes = [c for c in changes if c.get('changeType') == 'Delete']

          print("ðŸ“‹ What-If Analysis Results:")
          print(f"  ðŸŸ¢ Creates: {len(creates)}")
          print(f"  ðŸŸ¡ Modifies: {len(modifies)}")
          print(f"  ðŸ”´ Deletes: {len(deletes)}")
          print()

          if creates:
              print("**Resources to Create:**")
              for r in creates:
                  resource_id = r.get('resourceId', 'Unknown')
                  change_desc = r.get('description', '')
                  print(f"  - `{resource_id}`")
                  if change_desc and change_desc != 'Create':
                      print(f"    ({change_desc})")

          if modifies:
              print("\n**Resources to Modify:**")
              for r in modifies:
                  resource_id = r.get('resourceId', 'Unknown')
                  change_desc = r.get('description', '')
                  print(f"  - `{resource_id}`")
                  if change_desc and change_desc != 'Modify':
                      print(f"    ({change_desc})")

          if deletes:
              print("\n**Resources to Delete:**")
              for r in deletes:
                  resource_id = r.get('resourceId', 'Unknown')
                  change_desc = r.get('description', '')
                  print(f"  - `{resource_id}`")
                  if change_desc and change_desc != 'Delete':
                      print(f"    ({change_desc})")
          PYTHON
            python /tmp/parse-whatif.py
          else
            echo "âš ï¸ No what-if output generated (may be due to validation error)"
          fi

      # Note: No cleanup step; the validation RG is long-lived and pre-created

  comment-results:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: [bicep-lint, validate-template]
    if: github.event_name == 'pull_request' && always()
    steps:
      - name: Post validation results
        uses: actions/github-script@v8
        with:
          script: |
            const lint_result = '${{ needs.bicep-lint.result }}';
            const validate_result = '${{ needs.validate-template.result }}';
            const whatif_status = '${{ needs.validate-template.outputs.whatif-status }}';

            let status = 'âœ…';
            let details = '';

            if (lint_result !== 'success') {
              status = 'âŒ';
              details += '- Bicep linting failed\n';
            } else {
              details += '- âœ“ Bicep syntax valid\n';
              details += '- âœ“ Bicep linting passed\n';
            }

            if (validate_result === 'skipped') {
              details += '- âš ï¸ ARM validation skipped (Azure secrets not configured)\n';
            } else if (validate_result !== 'success') {
              status = 'âŒ';
              details += '- ARM template validation failed\n';
            } else {
              details += '- âœ“ ARM template validation passed\n';

              // Report what-if status based on captured exit code
              if (whatif_status === 'success') {
                details += '- âœ“ What-if analysis completed successfully\n';
              } else if (whatif_status === 'failed') {
                details += '- âš ï¸ What-if analysis failed (but syntax validation passed)\n';
              } else {
                details += `- âš ï¸ What-if analysis status unknown (received: ${whatif_status})\n`;
              }
            }

            const body = `## ${status} Bicep Validation Results\n\n${details}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
