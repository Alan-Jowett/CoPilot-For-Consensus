# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Copilot-for-Consensus contributors

name: Bicep Template Validation

on:
  pull_request:
    paths:
      - 'infra/azure/**'
  push:
    branches:
      - main
    paths:
      - 'infra/azure/**'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  pull-requests: write

concurrency:
  # Cancel any in-progress instance of this workflow for the same PR.
  # Allow running concurrently with any commits on any other branch.
  group: bicep-validate-${{ github.event.pull_request.number || github.sha || github.ref }}
  cancel-in-progress: true

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  VALIDATION_RESOURCE_GROUP: copilot-bicep-validation-rg

jobs:
  bicep-lint:
    name: Bicep Lint & Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az --version

      - name: Bicep build & lint - main.bicep
        run: |
          cd infra/azure
          az bicep build --file main.bicep
          echo "âœ“ main.bicep syntax valid"

      - name: Bicep build & lint - core.bicep
        run: |
          cd infra/azure
          az bicep build --file core.bicep
          echo "âœ“ core.bicep syntax valid"

      - name: Bicep lint - main.bicep
        run: |
          cd infra/azure
          az bicep lint --file main.bicep
          echo "âœ“ main.bicep linting complete"

      - name: Bicep lint - core.bicep
        run: |
          cd infra/azure
          az bicep lint --file core.bicep
          echo "âœ“ core.bicep linting complete"

      - name: Bicep lint - all modules
        run: |
          cd infra/azure
          EXIT_CODE=0
          echo "Linting all Bicep modules..."
          for module in modules/*.bicep; do
            echo "Linting $module..."
            if ! az bicep lint --file "$module"; then
              echo "âœ— Failed: $module"
              EXIT_CODE=1
            else
              echo "âœ“ Passed: $module"
            fi
          done
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ“ All modules linting complete"
          else
            echo "âœ— Some modules failed linting"
            exit 1
          fi

      - name: Validate parameter files
        run: |
          cd infra/azure
          EXIT_CODE=0
          echo "Validating all parameter files..."
          for param_file in parameters*.json; do
            echo "Validating $param_file..."
            if ! python3 -m json.tool "$param_file" > /dev/null; then
              echo "âœ— Invalid JSON: $param_file"
              EXIT_CODE=1
            else
              echo "âœ“ Valid JSON: $param_file"
            fi
          done
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ“ All parameter files valid"
          else
            echo "âœ— Some parameter files have invalid JSON"
            exit 1
          fi

      - name: Verify Bicep config exists
        run: |
          cd infra/azure
          if [ -f bicepconfig.json ]; then
            echo "âœ“ bicepconfig.json found"
            cat bicepconfig.json
          else
            echo "âš ï¸ bicepconfig.json not found - using default Bicep linter rules"
          fi

  validate-template:
    name: ARM Template Validation
    runs-on: ubuntu-latest
    needs: bicep-lint
    # Only run Azure validation if credentials are available
    if: ${{ github.event_name != 'pull_request' || (secrets.AZURE_CLIENT_ID != '' && secrets.AZURE_TENANT_ID != '' && secrets.AZURE_SUBSCRIPTION_ID != '') }}
    outputs:
      whatif-status: ${{ steps.whatif-step.outputs.status }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          enable-AzPSSession: false

      - name: Ensure validation resource group exists
        run: |
          RG_NAME="${{ env.VALIDATION_RESOURCE_GROUP }}"
          if ! az group show --name "$RG_NAME" >/dev/null 2>&1; then
            echo "âŒ Validation resource group '$RG_NAME' not found."
            echo "Please create it once with:"
            echo "  az group create --name $RG_NAME --location westus"
            exit 1
          fi
          echo "âœ“ Using validation RG: $RG_NAME"

      - name: Validate core.bicep template
        run: |
          cd infra/azure
          az deployment group validate \
            --resource-group ${{ env.VALIDATION_RESOURCE_GROUP }} \
            --template-file core.bicep \
            --parameters parameters.core.dev.json \
            --query "validationLevel" -o tsv
          echo "âœ“ Core template validation passed"

      - name: Run what-if analysis (core-dev)
        id: whatif-step
        continue-on-error: true
        run: |
          cd infra/azure

          # Run what-if and capture exit code
          set +e
          az deployment group what-if \
            --resource-group ${{ env.VALIDATION_RESOURCE_GROUP }} \
            --template-file core.bicep \
            --parameters parameters.core.dev.json \
            --output json > what-if-output.json
          WHATIF_EXIT_CODE=$?
          set -e

          # Set output based on exit code
          if [ $WHATIF_EXIT_CODE -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ“ What-if analysis completed successfully"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âš ï¸ What-if analysis failed with exit code: $WHATIF_EXIT_CODE"
          fi

      - name: Parse and comment what-if results
        if: github.event_name == 'pull_request'
        run: |
          # Extract resource changes from what-if output
          cd infra/azure
          if [ -f what-if-output.json ]; then
            cat > /tmp/parse-whatif.py << 'PYTHON'
          import json
          import sys

          try:
              with open('what-if-output.json') as f:
                  data = json.load(f)
          except (json.JSONDecodeError, FileNotFoundError, IOError) as e:
              print(f"Error reading what-if output: {e}")
              sys.exit(0)

          # Azure CLI what-if output has 'changes' array at top level
          changes = data.get('changes', [])
          if not changes:
              print("No resource changes detected")
              sys.exit(0)

          # Categorize changes by type
          creates = [c for c in changes if c.get('changeType') == 'Create']
          modifies = [c for c in changes if c.get('changeType') == 'Modify']
          deletes = [c for c in changes if c.get('changeType') == 'Delete']

          print("ðŸ“‹ What-If Analysis Results:")
          print(f"  ðŸŸ¢ Creates: {len(creates)}")
          print(f"  ðŸŸ¡ Modifies: {len(modifies)}")
          print(f"  ðŸ”´ Deletes: {len(deletes)}")
          print()

          if creates:
              print("**Resources to Create:**")
              for r in creates:
                  resource_id = r.get('resourceId', 'Unknown')
                  change_desc = r.get('description', '')
                  print(f"  - `{resource_id}`")
                  if change_desc and change_desc != 'Create':
                      print(f"    ({change_desc})")

          if modifies:
              print("\n**Resources to Modify:**")
              for r in modifies:
                  resource_id = r.get('resourceId', 'Unknown')
                  change_desc = r.get('description', '')
                  print(f"  - `{resource_id}`")
                  if change_desc and change_desc != 'Modify':
                      print(f"    ({change_desc})")

          if deletes:
              print("\n**Resources to Delete:**")
              for r in deletes:
                  resource_id = r.get('resourceId', 'Unknown')
                  change_desc = r.get('description', '')
                  print(f"  - `{resource_id}`")
                  if change_desc and change_desc != 'Delete':
                      print(f"    ({change_desc})")
          PYTHON
            python /tmp/parse-whatif.py
          else
            echo "âš ï¸ No what-if output generated (may be due to validation error)"
          fi

      # Note: No cleanup step; the validation RG is long-lived and pre-created

  arm-ttk-validation:
    name: ARM-TTK Best Practices
    runs-on: ubuntu-latest
    needs: bicep-lint
    # Continue even if ARM-TTK finds issues, but report them
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az --version

      - name: Build ARM templates from Bicep
        run: |
          cd infra/azure
          echo "Building ARM templates for validation..."
          az bicep build --file main.bicep --outfile main.json
          az bicep build --file core.bicep --outfile core.json
          echo "âœ“ ARM templates built successfully"

      - name: Download and run ARM-TTK
        continue-on-error: true
        run: |
          cd infra/azure
          
          # Download ARM-TTK
          echo "Downloading ARM Template Toolkit..."
          git clone --quiet --depth 1 https://github.com/Azure/arm-ttk.git /tmp/arm-ttk
          
          # Run ARM-TTK on generated templates (non-blocking)
          echo "Running ARM-TTK validation on main.json..."
          pwsh -Command "
            Import-Module /tmp/arm-ttk/arm-ttk/arm-ttk.psd1
            \$results = Test-AzTemplate -TemplatePath main.json -Skip 'apiVersions Should Be Recent','Parameters Must Be Referenced'
            \$results | Format-List
            Write-Host ''
            Write-Host 'ARM-TTK Results for main.json:'
            Write-Host \"  Total Tests: \$(\$results.Count)\"
            Write-Host \"  Passed: \$((\$results | Where-Object { \$_.Passed }).Count)\"
            Write-Host \"  Failed: \$((\$results | Where-Object { -not \$_.Passed }).Count)\"
          "
          
          echo ""
          echo "Running ARM-TTK validation on core.json..."
          pwsh -Command "
            Import-Module /tmp/arm-ttk/arm-ttk/arm-ttk.psd1
            \$results = Test-AzTemplate -TemplatePath core.json -Skip 'apiVersions Should Be Recent','Parameters Must Be Referenced'
            \$results | Format-List
            Write-Host ''
            Write-Host 'ARM-TTK Results for core.json:'
            Write-Host \"  Total Tests: \$(\$results.Count)\"
            Write-Host \"  Passed: \$((\$results | Where-Object { \$_.Passed }).Count)\"
            Write-Host \"  Failed: \$((\$results | Where-Object { -not \$_.Passed }).Count)\"
          "
          
          echo "âœ“ ARM-TTK validation complete (check results above)"

      - name: Cleanup ARM template artifacts
        if: always()
        run: |
          cd infra/azure
          rm -f main.json core.json


  comment-results:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: [bicep-lint, validate-template, arm-ttk-validation]
    if: github.event_name == 'pull_request' && always()
    steps:
      - name: Post validation results
        uses: actions/github-script@v7
        with:
          script: |
            const lint_result = '${{ needs.bicep-lint.result }}';
            const validate_result = '${{ needs.validate-template.result }}';
            const armttk_result = '${{ needs.arm-ttk-validation.result }}';
            const whatif_status = '${{ needs.validate-template.outputs.whatif-status }}';

            let status = 'âœ…';
            let details = '';

            if (lint_result !== 'success') {
              status = 'âŒ';
              details += '- Bicep linting failed\n';
            } else {
              details += '- âœ“ Bicep syntax valid (main.bicep, core.bicep)\n';
              details += '- âœ“ Bicep linting passed (all modules)\n';
              details += '- âœ“ Parameter files validated\n';
            }

            if (armttk_result === 'success') {
              details += '- âœ“ ARM-TTK best practices validation completed\n';
            } else if (armttk_result === 'failure') {
              details += '- âš ï¸ ARM-TTK found issues (see job logs for details)\n';
            } else if (armttk_result === 'cancelled') {
              details += '- âš ï¸ ARM-TTK validation cancelled\n';
            } else {
              details += '- âš ï¸ ARM-TTK validation skipped\n';
            }

            if (validate_result === 'skipped') {
              details += '- âš ï¸ ARM deployment validation skipped (Azure secrets not configured)\n';
            } else if (validate_result !== 'success' && validate_result !== 'skipped') {
              status = 'âŒ';
              details += '- ARM template deployment validation failed\n';
            } else if (validate_result === 'success') {
              details += '- âœ“ ARM template deployment validation passed\n';

              // Report what-if status based on captured exit code
              if (whatif_status === 'success') {
                details += '- âœ“ What-if analysis completed successfully\n';
              } else if (whatif_status === 'failed') {
                details += '- âš ï¸ What-if analysis failed (but syntax validation passed)\n';
              } else {
                details += `- âš ï¸ What-if analysis status unknown (received: ${whatif_status})\n`;
              }
            }

            const body = `## ${status} Bicep Validation Results\n\n${details}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
