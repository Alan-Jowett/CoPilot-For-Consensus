# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Copilot-for-Consensus contributors

name: Fuzzing Tests

on:
  push:
    branches: [ main ]
    paths:
      - 'fuzzing/**'
      - 'requirements-dev.txt'
      - '.github/workflows/fuzzing.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'fuzzing/**'
      - 'requirements-dev.txt'
      - '.github/workflows/fuzzing.yml'
  workflow_dispatch:  # Allow manual triggering
  schedule:
    # Run fuzzing tests weekly on Sunday at 00:00 UTC
    # Regular fuzzing helps catch regressions and edge cases over time
    - cron: '0 0 * * 0'

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  # Cancel any in-progress instance of this workflow for the same PR
  group: fuzzing-${{ github.event.pull_request.number || github.sha || github.ref }}
  cancel-in-progress: true

jobs:
  fuzzing:
    name: Fuzzing Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Conservative timeout to prevent resource exhaustion

    strategy:
      matrix:
        python-version: ["3.10"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Install adapters (for integration fuzzing)
        run: |
          # Install adapters needed for fuzzing tests:
          # - copilot_auth: Required for auth callback fuzzing
          # - copilot_metrics: Required for testing auth service metrics collection
          python adapters/scripts/install_adapters.py \
            copilot_config \
            copilot_storage \
            copilot_schema_validation \
            copilot_logging \
            copilot_auth \
            copilot_message_bus \
            copilot_metrics \
            copilot_error_reporting \
            copilot_archive_fetcher \
            copilot_archive_store

      - name: Install additional dependencies for ingestion fuzzing
        run: |
          # Install fastapi and pydantic for ingestion upload tests
          pip install fastapi pydantic

      - name: Run hypothesis property-based tests
        id: hypothesis
        run: |
          echo "::group::Running Hypothesis Tests"
          cd fuzzing
          # Run example tests and auth callback property tests
          pytest tests/test_hypothesis_example.py tests/test_auth_callback_fuzzing.py::TestCallbackPropertyBased -v --timeout=300 --junit-xml=hypothesis-results.xml
          # Run ingestion upload property tests
          pytest tests/test_ingestion_upload_properties.py -v --timeout=300 --junit-xml=ingestion-hypothesis-results.xml
          # Run reporting query params property tests
          pytest tests/test_reporting_query_params_fuzzing.py::TestReportingQueryParamsProperties -v --timeout=300 --junit-xml=reporting-hypothesis-results.xml
          # Run message bus event payload fuzzing tests
          pytest tests/test_message_bus_event_fuzzing.py -v --timeout=300 --junit-xml=message-bus-event-fuzzing-results.xml
          echo "::endgroup::"
        continue-on-error: true

      - name: Run JWT authentication fuzzing tests
        id: jwt-fuzzing
        run: |
          echo "::group::Running JWT Fuzzing Tests"
          cd fuzzing
          pytest tests/test_jwt_fuzzing.py -v --timeout=300 --junit-xml=jwt-fuzzing-results.xml
          echo "::endgroup::"
        continue-on-error: true

      - name: Run schemathesis API fuzzing tests
        id: schemathesis
        run: |
          echo "::group::Running Schemathesis Tests"
          cd fuzzing
          pytest tests/test_schemathesis_example.py tests/test_auth_callback_fuzzing.py::TestCallbackSchemathesis -v --timeout=300 --junit-xml=schemathesis-results.xml
          # Run reporting query params schema tests
          pytest tests/test_reporting_query_params_fuzzing.py::TestReportingSchemaFuzzing -v --timeout=300 --junit-xml=reporting-schema-results.xml
          echo "::endgroup::"
        continue-on-error: true
      
      - name: Run auth callback edge case tests
        id: auth_callback
        run: |
          echo "::group::Running Auth Callback Security Tests"
          cd fuzzing
          pytest tests/test_auth_callback_fuzzing.py::TestCallbackEdgeCases -v --timeout=300 --junit-xml=auth-callback-results.xml
          echo "::endgroup::"
        continue-on-error: true
      
      - name: Run reporting query params edge case tests
        id: reporting_edge_cases
        run: |
          echo "::group::Running Reporting Query Params Security Tests"
          cd fuzzing
          pytest tests/test_reporting_query_params_fuzzing.py::TestReportingSecurityEdgeCases -v --timeout=300 --junit-xml=reporting-edge-cases-results.xml
          echo "::endgroup::"
        continue-on-error: true

      - name: Run atheris fuzzing tests
        id: atheris
        run: |
          echo "::group::Running Atheris Tests"
          cd fuzzing
          # Atheris uses libFuzzer's execution model and is run as a standalone harness,
          # not as a regular pytest test. As a result, we cannot rely on pytest's
          # --timeout option here and instead enforce a wall-clock limit via the
          # shell `timeout` command to guard against infinite loops or long hangs.
          # Atheris may also be unavailable on some platforms due to compilation
          # requirements; in that case this command will fail quickly and we ignore it.
          
          # Run example atheris test
          timeout 60s python tests/test_atheris_example.py -atheris_runs=1000 || echo "Atheris example test completed or unavailable"
          
          # Run ingestion upload atheris fuzzing tests (multiple targets)
          timeout 60s python tests/test_ingestion_upload_fuzzing.py -target=sanitization -atheris_runs=5000 || echo "Sanitization fuzzing completed or unavailable"
          timeout 60s python tests/test_ingestion_upload_fuzzing.py -target=extension -atheris_runs=5000 || echo "Extension fuzzing completed or unavailable"
          timeout 60s python tests/test_ingestion_upload_fuzzing.py -target=mbox -atheris_runs=2000 || echo "Mbox fuzzing completed or unavailable"
          
          echo "::endgroup::"
        continue-on-error: true

      - name: Upload hypothesis test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: hypothesis-test-results
          path: |
            fuzzing/hypothesis-results.xml
            fuzzing/ingestion-hypothesis-results.xml
        continue-on-error: true

      - name: Upload JWT fuzzing test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: jwt-fuzzing-test-results
          path: fuzzing/jwt-fuzzing-results.xml
        continue-on-error: true

      - name: Upload schemathesis test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: schemathesis-test-results
          path: fuzzing/schemathesis-results.xml
        continue-on-error: true
      
      - name: Upload auth callback test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: auth-callback-test-results
          path: fuzzing/auth-callback-results.xml
        continue-on-error: true

      - name: Test Report - Hypothesis
        if: always()
        uses: dorny/test-reporter@b082adf0eced0765477756c2a610396589b8c637 # v2
        with:
          name: Hypothesis Test Results
          path: 'fuzzing/*-hypothesis-results.xml'
          reporter: 'java-junit'
        continue-on-error: true

      - name: Test Report - JWT Fuzzing
        if: always()
        uses: dorny/test-reporter@b082adf0eced0765477756c2a610396589b8c637 # v2
        with:
          name: JWT Fuzzing Test Results
          path: 'fuzzing/jwt-fuzzing-results.xml'
          reporter: 'java-junit'
        continue-on-error: true

      - name: Test Report - Schemathesis
        if: always()
        uses: dorny/test-reporter@b082adf0eced0765477756c2a610396589b8c637 # v2
        with:
          name: Schemathesis Test Results
          path: 'fuzzing/schemathesis-results.xml'
          reporter: 'java-junit'
        continue-on-error: true
      
      - name: Test Report - Auth Callback
        if: always()
        uses: dorny/test-reporter@b082adf0eced0765477756c2a610396589b8c637 # v2
        with:
          name: Auth Callback Security Test Results
          path: 'fuzzing/auth-callback-results.xml'
          reporter: 'java-junit'
        continue-on-error: true

      - name: Generate Fuzzing Summary
        if: always()
        run: |
          echo "## Fuzzing Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Fuzzing tests help find edge cases and security vulnerabilities through automated input generation." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          
          # Hypothesis status
          HYPOTHESIS_STATUS="${{ steps.hypothesis.outcome }}"
          if [ "$HYPOTHESIS_STATUS" = "success" ]; then
            echo "| Hypothesis | ✅ Passed | Property-based testing completed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Hypothesis | ⚠️ Issues Found | Check logs for details |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # JWT Fuzzing status
          JWT_FUZZING_STATUS="${{ steps.jwt-fuzzing.outcome }}"
          if [ "$JWT_FUZZING_STATUS" = "success" ]; then
            echo "| JWT Fuzzing | ✅ Passed | Authentication security fuzzing completed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| JWT Fuzzing | ⚠️ Issues Found | Check logs for details |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Schemathesis status
          SCHEMATHESIS_STATUS="${{ steps.schemathesis.outcome }}"
          if [ "$SCHEMATHESIS_STATUS" = "success" ]; then
            echo "| Schemathesis | ✅ Passed | API schema fuzzing completed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Schemathesis | ⚠️ Issues Found | Check logs for details |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Auth callback status
          AUTH_CALLBACK_STATUS="${{ steps.auth_callback.outcome }}"
          if [ "$AUTH_CALLBACK_STATUS" = "success" ]; then
            echo "| Auth Callback | ✅ Passed | OIDC callback security tests passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Auth Callback | ⚠️ Issues Found | Check logs for details |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Atheris status
          ATHERIS_STATUS="${{ steps.atheris.outcome }}"
          if [ "$ATHERIS_STATUS" = "success" ]; then
            echo "| Atheris | ✅ Passed | Coverage-guided fuzzing completed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Atheris | ⚠️ Skipped/Issues | May require platform-specific compilation |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### About Fuzzing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Hypothesis**: Tests properties and invariants across generated inputs" >> $GITHUB_STEP_SUMMARY
          echo "- **JWT Fuzzing**: Tests JWT authentication security (header parsing, signature validation, claims extraction)" >> $GITHUB_STEP_SUMMARY
          echo "- **Schemathesis**: Fuzzes REST APIs based on OpenAPI specifications" >> $GITHUB_STEP_SUMMARY
          echo "- **Atheris**: Coverage-guided fuzzing for finding crashes and edge cases" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### New: Ingestion Upload Security Tests (P0)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow includes comprehensive fuzzing for ingestion file upload security:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Filename sanitization**: 18 property tests + atheris fuzzing" >> $GITHUB_STEP_SUMMARY
          echo "- **Extension validation**: Hypothesis tests for bypass attempts" >> $GITHUB_STEP_SUMMARY
          echo "- **Mbox parsing**: Atheris fuzzing for crash detection" >> $GITHUB_STEP_SUMMARY
          echo "- **Protection against**: Path traversal, null byte injection, memory exhaustion" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [fuzzing/README.md](https://github.com/Alan-Jowett/CoPilot-For-Consensus/blob/main/fuzzing/README.md) for more information." >> $GITHUB_STEP_SUMMARY

      - name: Check for critical failures
        if: always()
        run: |
          # Fuzzing tests are informational and don't fail the build by default
          # This allows exploration without blocking PRs
          # Adjust this logic if you want to enforce stricter fuzzing requirements
          echo "Fuzzing tests completed. Review results above."
          
          # Uncomment to fail on hypothesis failures:
          # if [ "${{ steps.hypothesis.outcome }}" = "failure" ]; then
          #   echo "::error::Hypothesis property tests failed"
          #   exit 1
          # fi
