# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Copilot-for-Consensus contributors

name: Check Dependabot Configuration

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger
  pull_request:
    paths:
      - '**/requirements.txt'
      - '**/setup.py'
      - '.github/dependabot.yml'
      - 'scripts/update-dependabot.py'

jobs:
  check-dependabot:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'

      - name: Generate expected dependabot.yml
        run: |
          python scripts/update-dependabot.py .github/dependabot.yml.generated

      - name: Compare configurations
        id: compare
        run: |
          if ! diff -q .github/dependabot.yml .github/dependabot.yml.generated > /dev/null 2>&1; then
            echo "outdated=true" >> $GITHUB_OUTPUT
            echo "Dependabot configuration is outdated!"
            echo "Differences:"
            diff .github/dependabot.yml .github/dependabot.yml.generated || true
          else
            echo "outdated=false" >> $GITHUB_OUTPUT
            echo "Dependabot configuration is up to date ‚úÖ"
          fi

      - name: Find existing issue
        id: find-issue
        uses: actions/github-script@v8
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependabot-config'
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title === 'Dependabot configuration is out of date'
            );
            
            if (existingIssue) {
              core.setOutput('issue-number', existingIssue.number);
              core.setOutput('issue-exists', 'true');
            } else {
              core.setOutput('issue-exists', 'false');
            }

      - name: Create or update issue
        if: steps.compare.outputs.outdated == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            // Read the diff
            const { execSync } = require('child_process');
            let diffOutput = '';
            try {
              diffOutput = execSync('diff -u .github/dependabot.yml .github/dependabot.yml.generated', { encoding: 'utf-8' });
            } catch (error) {
              diffOutput = error.stdout || error.stderr || 'Unable to generate diff';
            }
            
            const issueBody = `## üîÑ Dependabot Configuration Out of Date
            
            The \`.github/dependabot.yml\` file is missing entries for some Python packages or has outdated configuration.
            
            ### How to Fix
            
            Run the auto-update script to regenerate the configuration:
            
            \`\`\`bash
            python scripts/update-dependabot.py
            \`\`\`
            
            Then commit and push the changes:
            
            \`\`\`bash
            git add .github/dependabot.yml
            git commit -m "chore: update dependabot configuration"
            git push
            \`\`\`
            
            ### Detected Differences
            
            <details>
            <summary>Show diff</summary>
            
            \`\`\`diff
            ${diffOutput}
            \`\`\`
            
            </details>
            
            ---
            
            *This issue was automatically created by the [check-dependabot workflow](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}).*
            *Last checked: ${new Date().toISOString()}*`;
            
            const issueExists = '${{ steps.find-issue.outputs.issue-exists }}' === 'true';
            const issueNumber = '${{ steps.find-issue.outputs.issue-number }}';
            
            if (issueExists) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNumber),
                body: `üîî Configuration is still out of date.\n\n${issueBody}`
              });
              console.log(`Updated existing issue #${issueNumber}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Dependabot configuration is out of date',
                body: issueBody,
                labels: ['dependabot-config', 'automation', 'maintenance']
              });
              console.log(`Created new issue #${issue.data.number}`);
            }

      - name: Close issue if configuration is current
        if: steps.compare.outputs.outdated == 'false' && steps.find-issue.outputs.issue-exists == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const issueNumber = '${{ steps.find-issue.outputs.issue-number }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber),
              body: '‚úÖ Dependabot configuration is now up to date. Closing this issue.'
            });
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber),
              state: 'closed'
            });
            
            console.log(`Closed issue #${issueNumber}`);

      - name: Fail workflow if outdated
        if: steps.compare.outputs.outdated == 'true' && github.event_name == 'pull_request'
        run: |
          echo "‚ùå Dependabot configuration is outdated!"
          echo "Please run: python scripts/update-dependabot.py"
          exit 1
