# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Copilot-for-Consensus contributors

name: Unified CI

on:
  push:
    branches: [ main ]
    paths:
      - 'chunking/**'
      - 'embedding/**'
      - 'ingestion/**'
      - 'orchestrator/**'
      - 'parsing/**'
      - 'reporting/**'
      - 'summarization/**'
      - 'adapters/**'
      - '.github/workflows/unified-ci.yml'
      - '.github/workflows/service-reusable-unit-test-ci.yml'
      - '.github/workflows/adapter-reusable-unit-test-ci.yml'
      - '.github/workflows/adapter-reusable-integration-ci.yml'
      - '.github/workflows/adapter-reusable-vectorstore-integration-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'chunking/**'
      - 'embedding/**'
      - 'ingestion/**'
      - 'orchestrator/**'
      - 'parsing/**'
      - 'reporting/**'
      - 'summarization/**'
      - 'adapters/**'
      - '.github/workflows/unified-ci.yml'
      - '.github/workflows/service-reusable-unit-test-ci.yml'
      - '.github/workflows/adapter-reusable-unit-test-ci.yml'
      - '.github/workflows/adapter-reusable-integration-ci.yml'
      - '.github/workflows/adapter-reusable-vectorstore-integration-ci.yml'
  schedule:
    - cron: '0 2 * * *'  # Run daily at 2 AM UTC
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' }}
    outputs:
      # Services
      chunking: ${{ steps.filter.outputs.chunking }}
      embedding: ${{ steps.filter.outputs.embedding }}
      ingestion: ${{ steps.filter.outputs.ingestion }}
      orchestrator: ${{ steps.filter.outputs.orchestrator }}
      parsing: ${{ steps.filter.outputs.parsing }}
      reporting: ${{ steps.filter.outputs.reporting }}
      summarization: ${{ steps.filter.outputs.summarization }}
      # Adapters
      copilot_auth: ${{ steps.filter.outputs.copilot_auth }}
      copilot_chunking: ${{ steps.filter.outputs.copilot_chunking }}
      copilot_config: ${{ steps.filter.outputs.copilot_config }}
      copilot_consensus: ${{ steps.filter.outputs.copilot_consensus }}
      copilot_embedding: ${{ steps.filter.outputs.copilot_embedding }}
      copilot_events: ${{ steps.filter.outputs.copilot_events }}
      copilot_logging: ${{ steps.filter.outputs.copilot_logging }}
      copilot_metrics: ${{ steps.filter.outputs.copilot_metrics }}
      copilot_archive_fetcher: ${{ steps.filter.outputs.copilot_archive_fetcher }}
      copilot_reporting: ${{ steps.filter.outputs.copilot_reporting }}
      copilot_schema_validation: ${{ steps.filter.outputs.copilot_schema_validation }}
      copilot_storage: ${{ steps.filter.outputs.copilot_storage }}
      copilot_summarization: ${{ steps.filter.outputs.copilot_summarization }}
      copilot_vectorstore: ${{ steps.filter.outputs.copilot_vectorstore }}
      copilot_draft_diff: ${{ steps.filter.outputs.copilot_draft_diff }}
      ci_workflows: ${{ steps.filter.outputs.ci_workflows }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Detect changed components
        id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        with:
          token: ${{ github.token }}
          filters: |
            ci_workflows:
              - '.github/workflows/unified-ci.yml'
              - '.github/workflows/service-reusable-unit-test-ci.yml'
              - '.github/workflows/adapter-reusable-unit-test-ci.yml'
              - '.github/workflows/adapter-reusable-integration-ci.yml'
              - '.github/workflows/adapter-reusable-vectorstore-integration-ci.yml'
            chunking:
              - 'chunking/**'
              - 'adapters/**'
            embedding:
              - 'embedding/**'
              - 'adapters/**'
            ingestion:
              - 'ingestion/**'
              - 'adapters/**'
            orchestrator:
              - 'orchestrator/**'
              - 'adapters/**'
            parsing:
              - 'parsing/**'
              - 'adapters/**'
            reporting:
              - 'reporting/**'
              - 'adapters/**'
            summarization:
              - 'summarization/**'
              - 'adapters/**'
            copilot_auth:
              - 'adapters/copilot_auth/**'
            copilot_config:
              - 'adapters/copilot_config/**'
            copilot_events:
              - 'adapters/copilot_events/**'
            copilot_logging:
              - 'adapters/copilot_logging/**'
            copilot_archive_fetcher:
              - 'adapters/copilot_archive_fetcher/**'
            copilot_metrics:
              - 'adapters/copilot_metrics/**'
            copilot_reporting:
              - 'adapters/copilot_reporting/**'
            copilot_storage:
              - 'adapters/copilot_storage/**'
            copilot_embedding:
              - 'adapters/copilot_embedding/**'
            copilot_chunking:
              - 'adapters/copilot_chunking/**'
            copilot_consensus:
              - 'adapters/copilot_consensus/**'
            copilot_schema_validation:
              - 'adapters/copilot_schema_validation/**'
            copilot_summarization:
              - 'adapters/copilot_summarization/**'
            copilot_vectorstore:
              - 'adapters/copilot_vectorstore/**'
            copilot_draft_diff:
              - 'adapters/copilot_draft_diff/**'

  # ==========================================
  # Service Test Jobs
  # ==========================================
  
  chunking:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.chunking == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'chunking'
      service_path: 'chunking'
      adapter_names: 'copilot_chunking copilot_config copilot_secrets copilot_events copilot_storage copilot_metrics copilot_reporting copilot_schema_validation copilot_logging copilot_startup'
      app_module: 'app'
      python_version: '3.10'
    secrets: inherit

  embedding:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.embedding == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'embedding'
      service_path: 'embedding'
      adapter_names: 'copilot_config copilot_secrets copilot_events copilot_storage copilot_vectorstore copilot_embedding copilot_metrics copilot_reporting copilot_schema_validation copilot_logging'
      app_module: 'app'
      python_version: '3.10'
    secrets: inherit

  ingestion:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.ingestion == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'ingestion'
      service_path: 'ingestion'
      adapter_names: 'copilot_config copilot_secrets copilot_archive_fetcher copilot_logging copilot_reporting copilot_metrics copilot_events copilot_storage copilot_schema_validation'
      app_module: 'app'
      python_version: '3.10'
    secrets: inherit

  orchestrator:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.orchestrator == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'orchestrator'
      service_path: 'orchestrator'
      adapter_names: 'copilot_config copilot_secrets copilot_events copilot_storage copilot_logging copilot_metrics copilot_reporting copilot_schema_validation'
      app_module: 'app'
      python_version: '3.10'
    secrets: inherit

  parsing:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.parsing == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'parsing'
      service_path: 'parsing'
      adapter_names: 'copilot_config copilot_secrets copilot_events copilot_storage copilot_metrics copilot_reporting copilot_logging copilot_schema_validation'
      app_module: 'app'
      python_version: '3.10'
    secrets: inherit

  reporting:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.reporting == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'reporting'
      service_path: 'reporting'
      adapter_names: 'copilot_config copilot_secrets copilot_events copilot_storage copilot_metrics copilot_reporting copilot_logging copilot_schema_validation'
      app_module: 'app'
      python_version: '3.10'
    secrets: inherit

  summarization:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.summarization == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'summarization'
      service_path: 'summarization'
      adapter_names: 'copilot_config copilot_secrets copilot_events copilot_storage copilot_vectorstore copilot_metrics copilot_reporting copilot_summarization copilot_logging copilot_schema_validation'
      app_module: 'app'
      python_version: '3.10'
    secrets: inherit

  # ==========================================
  # Adapter Test Jobs
  # ==========================================

  auth-ci:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.copilot_auth == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/adapter-reusable-unit-test-ci.yml
    with:
      adapter_id: copilot_auth
      adapter_path: adapters/copilot_auth
      package_name: copilot_auth

  config-ci:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.copilot_config == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/adapter-reusable-unit-test-ci.yml
    with:
      adapter_id: copilot_config
      adapter_path: adapters/copilot_config
      package_name: copilot_config
      extra_pip_packages: '["pyyaml>=6.0.0"]'

  events-ci:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.copilot_events == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/adapter-reusable-unit-test-ci.yml
    with:
      adapter_id: copilot_events
      adapter_path: adapters/copilot_events
      package_name: copilot_events

  logging-ci:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.copilot_logging == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/adapter-reusable-unit-test-ci.yml
    with:
      adapter_id: copilot_logging
      adapter_path: adapters/copilot_logging
      package_name: copilot_logging

  metrics-ci:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.copilot_metrics == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/adapter-reusable-unit-test-ci.yml
    with:
      adapter_id: copilot_metrics
      adapter_path: adapters/copilot_metrics
      package_name: copilot_metrics

  archive-fetcher-ci:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.copilot_archive_fetcher == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/adapter-reusable-unit-test-ci.yml
    with:
      adapter_id: copilot_archive_fetcher
      adapter_path: adapters/copilot_archive_fetcher
      package_name: copilot_archive_fetcher

  archive-fetcher-integration-ci:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.copilot_archive_fetcher == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/adapter-reusable-integration-ci.yml
    with:
      adapter_id: copilot_archive_fetcher
      adapter_path: adapters/copilot_archive_fetcher
      package_name: copilot_archive_fetcher
      enable_rsync_daemon: true
      rsync_module: data
      rsync_port: '8730'

  reporting-ci:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.copilot_reporting == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/adapter-reusable-unit-test-ci.yml
    with:
      adapter_id: copilot_reporting
      adapter_path: adapters/copilot_reporting
      package_name: copilot_reporting

  storage-ci:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.copilot_storage == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/adapter-reusable-unit-test-ci.yml
    with:
      adapter_id: copilot_storage
      adapter_path: adapters/copilot_storage
      package_name: copilot_storage

  embedding-ci:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.copilot_embedding == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/adapter-reusable-unit-test-ci.yml
    with:
      adapter_id: copilot_embedding
      adapter_path: adapters/copilot_embedding
      package_name: copilot_embedding
    secrets: inherit
    # Note: Uses mock backend by default, avoiding PyTorch installation in CI

  chunking-ci:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.copilot_chunking == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/adapter-reusable-unit-test-ci.yml
    with:
      adapter_id: copilot_chunking
      adapter_path: adapters/copilot_chunking
      package_name: copilot_chunking

  consensus-ci:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.copilot_consensus == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/adapter-reusable-unit-test-ci.yml
    with:
      adapter_id: copilot_consensus
      adapter_path: adapters/copilot_consensus
      package_name: copilot_consensus

  schema-validation-ci:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.copilot_schema_validation == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/adapter-reusable-unit-test-ci.yml
    with:
      adapter_id: copilot_schema_validation
      adapter_path: adapters/copilot_schema_validation
      package_name: copilot_schema_validation

  summarization-ci:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.copilot_summarization == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/adapter-reusable-unit-test-ci.yml
    with:
      adapter_id: copilot_summarization
      adapter_path: adapters/copilot_summarization
      package_name: copilot_summarization

  vectorstore-ci:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.copilot_vectorstore == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/adapter-reusable-unit-test-ci.yml
    with:
      adapter_id: copilot_vectorstore
      adapter_path: adapters/copilot_vectorstore
      package_name: copilot_vectorstore
      extra_pip_packages: '["faiss-cpu", "qdrant-client"]'

  vectorstore-integration-ci:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.copilot_vectorstore == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/adapter-reusable-vectorstore-integration-ci.yml
    with:
      adapter_id: copilot_vectorstore
      adapter_path: adapters/copilot_vectorstore
      package_name: copilot_vectorstore

  storage-integration-ci:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.copilot_storage == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/adapter-reusable-integration-ci.yml
    with:
      adapter_id: copilot_storage
      adapter_path: adapters/copilot_storage
      package_name: copilot_storage

  events-integration-ci:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.copilot_events == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/adapter-reusable-integration-ci.yml
    with:
      adapter_id: copilot_events
      adapter_path: adapters/copilot_events
      package_name: copilot_events

  schema-validation-integration-ci:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.copilot_schema_validation == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/adapter-reusable-integration-ci.yml
    with:
      adapter_id: copilot_schema_validation
      adapter_path: adapters/copilot_schema_validation
      package_name: copilot_schema_validation

  draft-diff:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.copilot_draft_diff == 'true' || needs.detect-changes.outputs.ci_workflows == 'true') }}
    uses: ./.github/workflows/adapter-reusable-unit-test-ci.yml
    with:
      adapter_id: copilot_draft_diff
      adapter_path: adapters/copilot_draft_diff
      package_name: copilot_draft_diff

  # ==========================================
  # Unified Coverage Summary
  # ==========================================
  
  coverage-summary:
    needs: 
      # Services
      - chunking
      - embedding
      - ingestion
      - orchestrator
      - parsing
      - reporting
      - summarization
      # Adapters
      - auth-ci
      - config-ci
      - events-ci
      - logging-ci
      - metrics-ci
      - archive-fetcher-ci
      - archive-fetcher-integration-ci
      - reporting-ci
      - storage-ci
      - storage-integration-ci
      - embedding-ci
      - chunking-ci
      - consensus-ci
      - schema-validation-ci
      - schema-validation-integration-ci
      - summarization-ci
      - vectorstore-ci
      - vectorstore-integration-ci
      - events-integration-ci
      - draft-diff
    runs-on: ubuntu-latest
    if: ${{ always() && github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      
      - name: Finalize coverage upload
        uses: coverallsapp/github-action@5cbfd81b66ca5d10c19b062c04de0199c215fb6e # v2
        with:
          github-token: ${{ github.token }}
          parallel-finished: true
          carryforward: >-
            chunking,embedding,ingestion,orchestrator,parsing,reporting,summarization,
            copilot_auth,copilot_config,copilot_events,copilot_logging,copilot_metrics,
            copilot_archive_fetcher,copilot_reporting,copilot_storage,copilot_embedding,
            copilot_chunking,copilot_consensus,copilot_schema_validation,copilot_summarization,
            copilot_vectorstore,copilot_draft_diff,
            copilot_archive_fetcher_integration,copilot_storage_integration,
            copilot_events_integration,copilot_schema_validation_integration,copilot_vectorstore_integration
