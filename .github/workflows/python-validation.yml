# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Copilot-for-Consensus contributors

name: Python Validation

on:
  push:
    branches: [ main ]
    paths:
      - '**.py'
      - 'pyproject.toml'
      - 'requirements-dev.txt'
      - '.github/workflows/python-validation.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '**.py'
      - 'pyproject.toml'
      - 'requirements-dev.txt'
      - '.github/workflows/python-validation.yml'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  # Cancel any in-progress instance of this workflow for the same PR.
  # Allow running concurrently with any commits on any other branch.
  group: python-validation-${{ github.event.pull_request.number || github.sha || github.ref }}
  cancel-in-progress: true

jobs:
  static-analysis:
    name: Static Type Checking and Linting
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      matrix:
        python-version: ["3.10"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install Node.js (for pyright)
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v4
        with:
          node-version: '20'

      - name: Install validation dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Install all adapters
        run: |
          # Install all adapters for comprehensive validation
          python adapters/scripts/install_adapters.py \
            copilot_auth \
            copilot_chunking \
            copilot_config \
            copilot_consensus \
            copilot_embedding \
            copilot_message_bus \
            copilot_logging \
            copilot_metrics \
            copilot_archive_fetcher \
            copilot_archive_store \
            copilot_error_reporting \
            copilot_schema_validation \
            copilot_secrets \
            copilot_storage \
            copilot_summarization \
            copilot_vectorstore \
            copilot_draft_diff \
            copilot_startup

      - name: Install ingestion service dependencies (for pyright)
        run: |
          # Pyright is configured with reportMissingImports=error; ensure third-party
          # deps used by ingestion entrypoints (e.g., uvicorn) are available.
          if [ -f "ingestion/requirements.txt" ]; then
            pip install -r ingestion/requirements.txt
          fi

      - name: Install auth service dependencies (for pyright)
        run: |
          # Ensure third-party deps used by auth entrypoints are available.
          if [ -f "auth/requirements.txt" ]; then
            pip install -r auth/requirements.txt
          fi

      - name: Install chunking service dependencies (for pyright)
        run: |
          # Ensure third-party deps used by chunking entrypoints are available.
          if [ -f "chunking/requirements.txt" ]; then
            pip install -r chunking/requirements.txt
          fi

      - name: Install embedding service dependencies (for pyright)
        run: |
          # Ensure third-party deps used by embedding entrypoints are available.
          if [ -f "embedding/requirements.txt" ]; then
            pip install -r embedding/requirements.txt
          fi

      - name: Ruff - Fast Python Linter
        id: ruff
        run: |
          echo "::group::Running Ruff"
          set +e
          ruff check . --output-format=github
          RUFF_EXIT=$?
          echo "exit_code=$RUFF_EXIT" >> $GITHUB_OUTPUT
          echo "::endgroup::"
          exit 0  # Don't fail here, we'll check later

      - name: Ruff - Check Import Sorting
        id: ruff-imports
        run: |
          echo "::group::Checking Import Order"
          set +e
          ruff check . --select I --output-format=github
          RUFF_IMPORT_EXIT=$?
          echo "exit_code=$RUFF_IMPORT_EXIT" >> $GITHUB_OUTPUT
          echo "::endgroup::"
          exit 0  # Don't fail here, we'll check later

      - name: Pylint - Attribute and Member Checking
        id: pylint
        run: |
          echo "::group::Running Pylint for Critical Checks"
          PYLINT_ERRORS=0

          # Run pylint on adapters focusing on attribute errors and undefined variables
          for adapter_dir in adapters/copilot_*/; do
            if [ -d "$adapter_dir" ]; then
              adapter_name=$(basename "$adapter_dir")
              echo "Checking $adapter_name..."
              set +e
              pylint "$adapter_dir/$adapter_name/" \
                --disable=all \
                --enable=E0602,E1101,E0611,E1102,E1120,E1121 \
                --output-format=colorized
              if [ $? -ne 0 ]; then
                PYLINT_ERRORS=$((PYLINT_ERRORS + 1))
                echo "::warning::Pylint found issues in $adapter_name"
              fi
            fi
          done

          # Run pylint on services
          for service_dir in auth chunking embedding ingestion orchestrator parsing reporting summarization; do
            targets=()
            if [ -d "$service_dir/app" ]; then
              targets+=("$service_dir/app/")
            fi
            if [ -f "$service_dir/main.py" ]; then
              targets+=("$service_dir/main.py")
            fi

            if [ ${#targets[@]} -gt 0 ]; then
              echo "Checking $service_dir..."
              set +e
              pylint "${targets[@]}" \
                --disable=all \
                --enable=E0602,E1101,E0611,E1102,E1120,E1121 \
                --output-format=colorized
              if [ $? -ne 0 ]; then
                PYLINT_ERRORS=$((PYLINT_ERRORS + 1))
                echo "::warning::Pylint found issues in $service_dir"
              fi
            fi
          done

          echo "error_count=$PYLINT_ERRORS" >> $GITHUB_OUTPUT
          echo "::endgroup::"

          if [ $PYLINT_ERRORS -gt 0 ]; then
            echo "::error::Pylint found critical errors in $PYLINT_ERRORS module(s)"
            exit 1
          fi

      - name: MyPy - Static Type Checking
        id: mypy
        run: |
          echo "::group::Running MyPy Type Checker"
          MYPY_ERRORS=0

          # Run mypy on adapters
          for adapter_dir in adapters/copilot_*/; do
            if [ -d "$adapter_dir" ]; then
              adapter_name=$(basename "$adapter_dir")
              echo "Type checking $adapter_name..."
              set +e
              mypy "$adapter_dir/$adapter_name/" --no-error-summary
              if [ $? -ne 0 ]; then
                MYPY_ERRORS=$((MYPY_ERRORS + 1))
                echo "::warning::MyPy found issues in $adapter_name"
              fi
            fi
          done

          # Run mypy on services (may have more external dependencies)
          for service_dir in auth chunking embedding ingestion orchestrator parsing reporting summarization; do
            targets=()
            if [ -d "$service_dir/app" ]; then
              targets+=("$service_dir/app/")
            fi
            if [ -f "$service_dir/main.py" ]; then
              targets+=("$service_dir/main.py")
            fi

            if [ ${#targets[@]} -gt 0 ]; then
              echo "Type checking $service_dir..."
              set +e
              mypy "${targets[@]}" --no-error-summary
              if [ $? -ne 0 ]; then
                MYPY_ERRORS=$((MYPY_ERRORS + 1))
                echo "::warning::MyPy found issues in $service_dir"
              fi
            fi
          done

          echo "error_count=$MYPY_ERRORS" >> $GITHUB_OUTPUT
          echo "::endgroup::"

          if [ $MYPY_ERRORS -gt 0 ]; then
            echo "::warning::MyPy found type errors in $MYPY_ERRORS module(s)"
          fi

          # Do not fail the build on MyPy yet; report in summary instead
          exit 0

      - name: Pyright - Strict Type Checking
        id: pyright
        run: |
          echo "::group::Running Pyright Type Checker"
          # Install pyright globally via npm
          npm install -g pyright

          PYRIGHT_ERRORS=0

          # Run pyright on adapters
          for adapter_dir in adapters/copilot_*/; do
            if [ -d "$adapter_dir" ]; then
              adapter_name=$(basename "$adapter_dir")
              echo "Type checking $adapter_name..."
              set +e
              pyright "$adapter_dir/$adapter_name/" --level error
              if [ $? -ne 0 ]; then
                PYRIGHT_ERRORS=$((PYRIGHT_ERRORS + 1))
                echo "::warning::Pyright found issues in $adapter_name"
              fi
            fi
          done

          # Run pyright on services
          for service_dir in auth chunking embedding ingestion orchestrator parsing reporting summarization; do
            targets=()
            if [ -d "$service_dir/app" ]; then
              targets+=("$service_dir/app/")
            fi
            if [ -f "$service_dir/main.py" ]; then
              targets+=("$service_dir/main.py")
            fi

            if [ ${#targets[@]} -gt 0 ]; then
              echo "Type checking $service_dir..."
              set +e
              pyright "${targets[@]}" --level error
              if [ $? -ne 0 ]; then
                PYRIGHT_ERRORS=$((PYRIGHT_ERRORS + 1))
                echo "::warning::Pyright found issues in $service_dir"
              fi
            fi
          done

          echo "error_count=$PYRIGHT_ERRORS" >> $GITHUB_OUTPUT
          echo "::endgroup::"

          if [ $PYRIGHT_ERRORS -gt 0 ]; then
            echo "::warning::Pyright found type errors in $PYRIGHT_ERRORS module(s)"
          fi

          # Do not fail the build on Pyright yet; report in summary instead
          exit 0

      - name: Pyright (gating) - Ingestion typed config safety
        run: |
          # This is the shift-left guardrail: catch missing/incorrect config attribute
          # access (e.g., config.storage_path vs config.service_settings.storage_path)
          # before merge.
          pyright ingestion/main.py ingestion/app/service.py --level error

      - name: Pyright (gating) - Auth typed config safety
        run: |
          # Auth uses schema-driven config; this guards against config schema drift
          # and missing attribute access in entrypoints and core logic.
          pyright auth/main.py auth/app/config.py auth/app/service.py auth/app/role_store.py --level error

      - name: Pyright (gating) - Chunking typed config safety
        run: |
          # Chunking uses schema-driven config; this guards against config schema drift
          # and missing attribute access in the entrypoint and core service.
          pyright chunking/main.py chunking/app/service.py --level error

      - name: Pyright (gating) - Embedding typed config safety
        run: |
          # Embedding uses schema-driven config; this guards against config schema drift
          # and missing attribute access in the entrypoint and core service.
          pyright embedding/main.py embedding/app/service.py --level error

      - name: Generate Validation Summary
        if: always()
        run: |
          echo "## Python Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Tool status
          echo "### Static Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Status | Errors |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|--------|" >> $GITHUB_STEP_SUMMARY

          # Ruff
          RUFF_STATUS="${{ steps.ruff.outputs.exit_code }}"
          if [ "$RUFF_STATUS" = "0" ]; then
            echo "| Ruff | ✅ Passed | 0 |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Ruff | ⚠️ Issues Found | - |" >> $GITHUB_STEP_SUMMARY
          fi

          # Pylint
          PYLINT_ERRORS="${{ steps.pylint.outputs.error_count }}"
          if [ "$PYLINT_ERRORS" = "0" ] || [ -z "$PYLINT_ERRORS" ]; then
            echo "| Pylint | ✅ Passed | 0 |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Pylint | ❌ Failed | $PYLINT_ERRORS module(s) |" >> $GITHUB_STEP_SUMMARY
          fi

          # MyPy
          MYPY_ERRORS="${{ steps.mypy.outputs.error_count }}"
          if [ "$MYPY_ERRORS" = "0" ] || [ -z "$MYPY_ERRORS" ]; then
            echo "| MyPy | ✅ Passed | 0 |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| MyPy | ❌ Failed | $MYPY_ERRORS module(s) |" >> $GITHUB_STEP_SUMMARY
          fi

          # Pyright
          PYRIGHT_ERRORS="${{ steps.pyright.outputs.error_count }}"
          if [ "$PYRIGHT_ERRORS" = "0" ] || [ -z "$PYRIGHT_ERRORS" ]; then
            echo "| Pyright | ✅ Passed | 0 |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Pyright | ❌ Failed | $PYRIGHT_ERRORS module(s) |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Critical Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following checks will **fail the build** if they detect errors:" >> $GITHUB_STEP_SUMMARY
          echo "- **Pylint** (E0602: undefined-variable, E1101: no-member, E0611: no-name-in-module)" >> $GITHUB_STEP_SUMMARY
          echo "- **Import smoke tests** (critical import/runtime errors)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Informational (non-blocking) results:" >> $GITHUB_STEP_SUMMARY
          echo "- **MyPy** and **Pyright** (reported above; reviewed but not gating yet)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "These checks catch hallucinated methods, attributes, and variables in LLM-generated code." >> $GITHUB_STEP_SUMMARY

  import-smoke-tests:
    name: Import Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      matrix:
        python-version: ["3.10"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-timeout

      - name: Install all adapters
        run: |
          # Install all adapters for import testing
          python adapters/scripts/install_adapters.py \
            copilot_auth \
            copilot_chunking \
            copilot_config \
            copilot_consensus \
            copilot_embedding \
            copilot_message_bus \
            copilot_logging \
            copilot_metrics \
            copilot_archive_fetcher \
            copilot_archive_store \
            copilot_error_reporting \
            copilot_schema_validation \
            copilot_secrets \
            copilot_storage \
            copilot_summarization \
            copilot_vectorstore \
            copilot_draft_diff \
            copilot_startup

      - name: Install service dependencies (minimal)
        run: |
          # Install minimal dependencies for each service to enable imports
          for service_dir in auth chunking embedding ingestion orchestrator parsing reporting summarization; do
            if [ -f "$service_dir/requirements.txt" ]; then
              echo "Installing dependencies for $service_dir..."
              pip install -r "$service_dir/requirements.txt" || echo "Some dependencies for $service_dir failed to install"
            fi
          done

      - name: Run import smoke tests
        env:
          PYTHONWARNINGS: default::DeprecationWarning,default::FutureWarning
        run: |
          echo "::group::Running Import Smoke Tests"
          pytest tests/test_imports.py -v --tb=short --timeout=60 --junit-xml=test-results.xml
          echo "::endgroup::"

      - name: Test Report
        if: always()
        uses: dorny/test-reporter@b082adf0eced0765477756c2a610396589b8c637 # v2
        with:
          name: Import Smoke Test Results
          path: 'test-results.xml'
          reporter: 'java-junit'
        continue-on-error: true

  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [static-analysis, import-smoke-tests]
    if: always()

    steps:
      - name: Report Status
        run: |
          echo "## Overall Python Validation Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Static Analysis: ${{ needs.static-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Import Smoke Tests: ${{ needs.import-smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.static-analysis.result }}" = "success" ] && [ "${{ needs.import-smoke-tests.result }}" = "success" ]; then
            echo "✅ All validation checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Some validation checks reported issues. Please review." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for Critical Failures
        run: |
          if [ "${{ needs.import-smoke-tests.result }}" = "failure" ]; then
            echo "::error::Import smoke tests failed - critical import errors detected"
            exit 1
          fi
