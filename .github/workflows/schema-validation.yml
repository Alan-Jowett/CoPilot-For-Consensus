# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Copilot-for-Consensus contributors

name: Schema Validation

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/schemas/configs/**'
      - 'adapters/copilot_config/**'
      - 'adapters/copilot_config/copilot_config/generated/**'
      - 'scripts/generate_typed_configs.py'
      - '.github/workflows/schema-validation.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/schemas/configs/**'
      - 'adapters/copilot_config/**'
      - 'adapters/copilot_config/copilot_config/generated/**'
      - 'scripts/generate_typed_configs.py'
      - '.github/workflows/schema-validation.yml'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  # Cancel any in-progress instance of this workflow for the same PR.
  # Allow running concurrently with any commits on any other branch.
  group: schema-validation-${{ github.event.pull_request.number || github.sha || github.ref }}
  cancel-in-progress: true

jobs:
  validate-schemas:
    name: Validate Configuration Schemas
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch full history for comparison

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema
          cd adapters/copilot_config
          pip install -e .

      - name: Validate schema JSON syntax
        run: |
          echo "Validating JSON syntax for all config schemas..."
          python - <<'PYTHON_VALIDATE_JSON'
          import glob
          import json
          import sys

          errors = []
          for schema_path in glob.glob('docs/schemas/configs/services/*.json'):
              print(f"Validating {schema_path}...")
              try:
                  with open(schema_path, 'r', encoding='utf-8') as f:
                      json.load(f)
              except Exception as exc:
                  print(f"ERROR: Failed to parse {schema_path}: {exc}")
                  errors.append(schema_path)

          if errors:
              sys.exit(1)

          print("✓ All schemas have valid JSON syntax")
          PYTHON_VALIDATE_JSON

      - name: Check schema version fields
        run: |
          echo "Checking that all schemas have version fields..."
          python - <<'PYTHON_SCRIPT'
          import json
          import sys
          import glob

          errors = []
          for schema_file in glob.glob('docs/schemas/configs/services/*.json'):
              print(f"Checking {schema_file}...")
              try:
                  with open(schema_file, encoding='utf-8') as f:
                      schema = json.load(f)
                  if 'schema_version' not in schema:
                      errors.append(f'ERROR: Missing schema_version in {schema_file}')
                  if 'min_service_version' not in schema:
                      errors.append(f'ERROR: Missing min_service_version in {schema_file}')
                  if 'schema_version' in schema and 'min_service_version' in schema:
                      print(f'✓ {schema_file} has version fields')
              except Exception as e:
                  print(f'ERROR: Failed to check {schema_file}: {e}')
                  sys.exit(1)

          if errors:
              for error in errors:
                  print(error)
              sys.exit(1)

          print("✓ All schemas have required version fields")
          PYTHON_SCRIPT

      - name: Check for breaking changes in modified schemas
        if: github.event_name == 'pull_request'
        run: |
          echo "Checking for breaking changes in modified schemas..."

          # Get list of modified schema files
          modified_schemas=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep 'docs/schemas/configs/.*\.json$' || true)

          if [ -z "$modified_schemas" ]; then
            echo "No schema files changed"
            exit 0
          fi

          for schema in $modified_schemas; do
            if [ -f "$schema" ]; then
              echo "Checking compatibility for $schema..."

              # Get the old version from base branch
              if git show origin/${{ github.base_ref }}:"$schema" > /tmp/old_schema.json 2>/dev/null; then
                # Basic compatibility check (inline Python)
                python - "$schema" <<'PYTHON_COMPAT_CHECK'
          import json
          import sys

          new_schema_path = sys.argv[1]

          with open('/tmp/old_schema.json', 'r') as f:
              old = json.load(f)
          with open(new_schema_path, 'r') as f:
              new = json.load(f)

          # Check for removed required fields (breaking change)
          if 'required' in old and 'required' in new:
              removed_required = set(old.get('required', [])) - set(new.get('required', []))
              if removed_required:
                  print(f"❌ Breaking change: removed required fields: {removed_required}")
                  sys.exit(1)
              added_required = set(new.get('required', [])) - set(old.get('required', []))
              if added_required:
                  print(f"❌ Breaking change: added required fields: {added_required}")
                  sys.exit(1)

          # Check for removed enum values (breaking change for discriminants)
          if 'properties' in old and 'discriminant' in old['properties']:
              old_enum = set(old['properties']['discriminant'].get('enum', []))
              if 'properties' in new and 'discriminant' in new['properties']:
                  new_enum = set(new['properties']['discriminant'].get('enum', []))
                  removed_enum = old_enum - new_enum
                  if removed_enum:
                      print(f"❌ Breaking change: removed discriminant values: {removed_enum}")
                      sys.exit(1)

          # Check for type changes in common properties
          if 'properties' in old and 'properties' in new:
              common_props = set(old['properties'].keys()) & set(new['properties'].keys())
              for prop in common_props:
                  old_type = old['properties'][prop].get('type')
                  new_type = new['properties'][prop].get('type')
                  if old_type and new_type and old_type != new_type:
                      print(f"❌ Breaking change: property '{prop}' type changed from {old_type} to {new_type}")
                      sys.exit(1)

          print("✓ No breaking changes detected")
          PYTHON_COMPAT_CHECK

                if [ $? -ne 0 ]; then
                  echo "❌ Compatibility check failed for $schema"
                  exit 1
                fi
                echo "✓ No breaking changes detected in $schema"
              else
                echo "New schema file detected: $schema (skipping compatibility check)"
              fi
            fi
          done

          echo "✓ All schema changes are compatible"

      - name: Validate schema against JSON Schema draft
        run: |
          echo "Validating schemas against JSON Schema draft..."
          python -c "
          import json
          import sys
          from jsonschema import Draft202012Validator, ValidationError

          errors = []
          for schema_file in [
              'docs/schemas/configs/services/auth.json',
              'docs/schemas/configs/services/chunking.json',
              'docs/schemas/configs/services/embedding.json',
              'docs/schemas/configs/services/ingestion.json',
              'docs/schemas/configs/services/orchestrator.json',
              'docs/schemas/configs/services/parsing.json',
              'docs/schemas/configs/services/reporting.json',
              'docs/schemas/configs/services/summarization.json',
          ]:
              try:
                  with open(schema_file, 'r') as f:
                      schema = json.load(f)

                  # Check that schema has required top-level fields
                  if 'service_name' not in schema:
                      errors.append(f'{schema_file}: Missing service_name')
                  if 'service_settings' not in schema:
                      errors.append(f'{schema_file}: Missing service_settings')

                  print(f'✓ {schema_file} is valid')
              except Exception as e:
                  errors.append(f'{schema_file}: {e}')

          if errors:
              print('\\n❌ Schema validation errors:')
              for error in errors:
                  print(f'  - {error}')
              sys.exit(1)

          print('\\n✓ All schemas are valid')
          "

      - name: Validate typed config generation (drift check)
        run: |
          echo "Checking that generated typed configs are up-to-date..."
          
          # Generate typed configs for all services
          python scripts/generate_typed_configs.py --all
          
          # Check if any files changed
          if ! git diff --exit-code adapters/copilot_config/copilot_config/generated/; then
            echo "❌ ERROR: Generated typed config files are out of sync with schemas!"
            echo ""
            echo "The following files have changed:"
            git diff --name-only adapters/copilot_config/copilot_config/generated/
            echo ""
            echo "To fix this, run the following command and commit the changes:"
            echo "  python scripts/generate_typed_configs.py --all"
            echo "  git add adapters/copilot_config/copilot_config/generated/"
            echo "  git commit -m 'chore: regenerate typed configs'"
            exit 1
          fi
          
          echo "✓ Generated typed configs are up-to-date"

      - name: Summary
        if: always()
        run: |
          echo "Schema validation complete"
          echo "- JSON syntax validation"
          echo "- Version field validation"
          echo "- Compatibility checking"
          echo "- JSON Schema draft validation"
          echo "- Typed config generation drift check"
