# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Copilot-for-Consensus contributors

name: Services CI (Changed-Only)

on:
  push:
    branches: [ main ]
    paths:
      - 'chunking/**'
      - 'embedding/**'
      - 'error-reporting/**'
      - 'ingestion/**'
      - 'orchestrator/**'
      - 'parsing/**'
      - 'reporting/**'
      - 'summarization/**'
      - 'adapters/**'
      - '.github/workflows/services-ci.yml'
      - '.github/workflows/service-reusable-unit-test-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'chunking/**'
      - 'embedding/**'
      - 'error-reporting/**'
      - 'ingestion/**'
      - 'orchestrator/**'
      - 'parsing/**'
      - 'reporting/**'
      - 'summarization/**'
      - 'adapters/**'
      - '.github/workflows/services-ci.yml'
      - '.github/workflows/service-reusable-unit-test-ci.yml'

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      chunking: ${{ steps.filter.outputs.chunking }}
      embedding: ${{ steps.filter.outputs.embedding }}
      error-reporting: ${{ steps.filter.outputs.error-reporting }}
      ingestion: ${{ steps.filter.outputs.ingestion }}
      orchestrator: ${{ steps.filter.outputs.orchestrator }}
      parsing: ${{ steps.filter.outputs.parsing }}
      reporting: ${{ steps.filter.outputs.reporting }}
      summarization: ${{ steps.filter.outputs.summarization }}
      ci-workflows: ${{ steps.filter.outputs.ci-workflows }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Detect changed services
        id: filter
        uses: dorny/paths-filter@v3
        with:
          token: ${{ github.token }}
          filters: |
            ci-workflows:
              - '.github/workflows/service-reusable-unit-test-ci.yml'
              - '.github/workflows/services-ci.yml'
            chunking:
              - 'chunking/**'
              - 'adapters/**'
            embedding:
              - 'embedding/**'
              - 'adapters/**'
            error-reporting:
              - 'error-reporting/**'
              - 'adapters/**'
            ingestion:
              - 'ingestion/**'
              - 'adapters/**'
            orchestrator:
              - 'orchestrator/**'
              - 'adapters/**'
            parsing:
              - 'parsing/**'
              - 'adapters/**'
            reporting:
              - 'reporting/**'
              - 'adapters/**'
            summarization:
              - 'summarization/**'
              - 'adapters/**'

  chunking:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.chunking == 'true' || needs.detect-changes.outputs.ci-workflows == 'true' }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'chunking'
      service_path: 'chunking'
      app_module: 'app'
      python_version: '3.11'
    secrets: inherit

  embedding:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.embedding == 'true' || needs.detect-changes.outputs.ci-workflows == 'true' }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'embedding'
      service_path: 'embedding'
      app_module: 'app'
      python_version: '3.11'
    secrets: inherit

  ingestion:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.ingestion == 'true' || needs.detect-changes.outputs.ci-workflows == 'true' }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'ingestion'
      service_path: 'ingestion'
      app_module: 'app'
      python_version: '3.11'
      run_local_test: true
      local_test_script: |
        import tempfile
        import os
        from app.config import IngestionConfig, SourceConfig
        from copilot_events import create_publisher
        from app.service import IngestionService
        
        # Create temp directories
        with tempfile.TemporaryDirectory() as tmpdir:
            storage_path = os.path.join(tmpdir, 'archives')
            os.makedirs(storage_path)
            
            # Create test archive
            source_dir = os.path.join(tmpdir, 'sources')
            os.makedirs(source_dir)
            test_file = os.path.join(source_dir, 'test.mbox')
            with open(test_file, 'w') as f:
                f.write('From: test@example.com\nSubject: Test\n\nContent')
            
            # Configure and run ingestion
            config = IngestionConfig(storage_path=storage_path)
            source = SourceConfig(
                name='test-source',
                source_type='local',
                url=test_file,
            )
            config.sources = [source]
            
            publisher = create_publisher(message_bus_type='noop')
            publisher.connect()
            service = IngestionService(config, publisher)
            
            # Run ingestion
            success = service.ingest_archive(source, max_retries=1)
            
            if success:
                print('✓ Local ingestion test passed')
            else:
                print('✗ Local ingestion test failed')
                exit(1)
    secrets: inherit

  orchestrator:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.orchestrator == 'true' || needs.detect-changes.outputs.ci-workflows == 'true' }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'orchestrator'
      service_path: 'orchestrator'
      app_module: 'app'
      python_version: '3.11'
    secrets: inherit

  parsing:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.parsing == 'true' || needs.detect-changes.outputs.ci-workflows == 'true' }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'parsing'
      service_path: 'parsing'
      app_module: 'app'
      python_version: '3.11'
    secrets: inherit

  # Commented out until reporting service is ready
  # reporting:
  #   needs: detect-changes
  #   if: ${{ needs.detect-changes.outputs.reporting == 'true' || needs.detect-changes.outputs.ci-workflows == 'true' }}
  #   uses: ./.github/workflows/service-reusable-unit-test-ci.yml
  #   with:
  #     service_id: 'reporting'
  #     service_path: 'reporting'
  #     app_module: 'app'
  #     python_version: '3.11'
  #   secrets: inherit

  summarization:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.summarization == 'true' || needs.detect-changes.outputs.ci-workflows == 'true' }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'summarization'
      service_path: 'summarization'
      app_module: 'app'
      python_version: '3.11'
    secrets: inherit

  error-reporting:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.error-reporting == 'true' || needs.detect-changes.outputs.ci-workflows == 'true' }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'error-reporting'
      service_path: 'error-reporting'
      app_module: 'app'
      python_version: '3.11'
    secrets: inherit