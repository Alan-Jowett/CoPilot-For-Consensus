# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Copilot-for-Consensus contributors

name: Services CI

on:
  push:
    branches: [ main ]
    paths:
      - 'chunking/**'
      - 'embedding/**'
      - 'error-reporting/**'
      - 'ingestion/**'
      - 'orchestrator/**'
      - 'parsing/**'
      - 'reporting/**'
      - 'summarization/**'
      - 'adapters/**'
      - '.github/workflows/services-ci.yml'
      - '.github/workflows/service-reusable-unit-test-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'chunking/**'
      - 'embedding/**'
      - 'error-reporting/**'
      - 'ingestion/**'
      - 'orchestrator/**'
      - 'parsing/**'
      - 'reporting/**'
      - 'summarization/**'
      - 'adapters/**'
      - '.github/workflows/services-ci.yml'
      - '.github/workflows/service-reusable-unit-test-ci.yml'
  schedule:
    - cron: '0 2 * * *'  # Run daily at 2 AM UTC
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'schedule' && github.event_name != 'workflow_dispatch' && github.event_name == 'pull_request' }}
    outputs:
      chunking: ${{ steps.filter.outputs.chunking }}
      embedding: ${{ steps.filter.outputs.embedding }}
      error-reporting: ${{ steps.filter.outputs.error-reporting }}
      ingestion: ${{ steps.filter.outputs.ingestion }}
      orchestrator: ${{ steps.filter.outputs.orchestrator }}
      parsing: ${{ steps.filter.outputs.parsing }}
      reporting: ${{ steps.filter.outputs.reporting }}
      summarization: ${{ steps.filter.outputs.summarization }}
      ci-workflows: ${{ steps.filter.outputs.ci-workflows }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Detect changed services
        id: filter
        uses: dorny/paths-filter@v3
        with:
          token: ${{ github.token }}
          filters: |
            ci-workflows:
              - '.github/workflows/service-reusable-unit-test-ci.yml'
              - '.github/workflows/services-ci.yml'
            chunking:
              - 'chunking/**'
              - 'adapters/**'
            embedding:
              - 'embedding/**'
              - 'adapters/**'
            error-reporting:
              - 'error-reporting/**'
              - 'adapters/**'
            ingestion:
              - 'ingestion/**'
              - 'adapters/**'
            orchestrator:
              - 'orchestrator/**'
              - 'adapters/**'
            parsing:
              - 'parsing/**'
              - 'adapters/**'
            reporting:
              - 'reporting/**'
              - 'adapters/**'
            summarization:
              - 'summarization/**'
              - 'adapters/**'

  chunking:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.chunking == 'true' || needs.detect-changes.outputs.ci-workflows == 'true') }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'chunking'
      service_path: 'chunking'
      adapter_names: 'copilot_chunking copilot_config copilot_events copilot_storage copilot_metrics copilot_reporting copilot_schema_validation copilot_logging'
      app_module: 'app'
      python_version: '3.10'
    secrets: inherit

  embedding:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.embedding == 'true' || needs.detect-changes.outputs.ci-workflows == 'true') }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'embedding'
      service_path: 'embedding'
      adapter_names: 'copilot_config copilot_events copilot_storage copilot_vectorstore copilot_embedding copilot_metrics copilot_reporting copilot_schema_validation copilot_logging'
      app_module: 'app'
      python_version: '3.10'
    secrets: inherit

  ingestion:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.ingestion == 'true' || needs.detect-changes.outputs.ci-workflows == 'true') }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'ingestion'
      service_path: 'ingestion'
      adapter_names: 'copilot_config copilot_archive_fetcher copilot_logging copilot_reporting copilot_metrics copilot_events copilot_storage copilot_schema_validation'
      app_module: 'app'
      python_version: '3.10'
    secrets: inherit

  orchestrator:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.orchestrator == 'true' || needs.detect-changes.outputs.ci-workflows == 'true') }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'orchestrator'
      service_path: 'orchestrator'
      adapter_names: 'copilot_config copilot_events copilot_storage copilot_logging copilot_metrics copilot_reporting copilot_schema_validation'
      app_module: 'app'
      python_version: '3.10'
    secrets: inherit

  parsing:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.parsing == 'true' || needs.detect-changes.outputs.ci-workflows == 'true') }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'parsing'
      service_path: 'parsing'
      adapter_names: 'copilot_config copilot_events copilot_storage copilot_metrics copilot_reporting copilot_logging copilot_schema_validation'
      app_module: 'app'
      python_version: '3.10'
    secrets: inherit

  reporting:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.reporting == 'true' || needs.detect-changes.outputs.ci-workflows == 'true') }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'reporting'
      service_path: 'reporting'
      adapter_names: 'copilot_config copilot_events copilot_storage copilot_metrics copilot_reporting copilot_logging copilot_schema_validation'
      app_module: 'app'
      python_version: '3.10'
    secrets: inherit

  summarization:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.summarization == 'true' || needs.detect-changes.outputs.ci-workflows == 'true') }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'summarization'
      service_path: 'summarization'
      adapter_names: 'copilot_config copilot_events copilot_storage copilot_vectorstore copilot_metrics copilot_reporting copilot_summarization copilot_logging copilot_schema_validation'
      app_module: 'app'
      python_version: '3.10'
    secrets: inherit

  error-reporting:
    needs: detect-changes
    if: ${{ always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.detect-changes.outputs.error-reporting == 'true' || needs.detect-changes.outputs.ci-workflows == 'true') }}
    uses: ./.github/workflows/service-reusable-unit-test-ci.yml
    with:
      service_id: 'error-reporting'
      service_path: 'error-reporting'
      adapter_names: 'copilot_config copilot_logging'
      app_module: 'app'
      python_version: '3.10'
    secrets: inherit

  # Aggregate coverage from all services on main branch
  coverage-summary:
    needs: [chunking, embedding, ingestion, orchestrator, parsing, reporting, summarization, error-reporting]
    runs-on: ubuntu-latest
    if: ${{ always() && github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Finalize coverage upload
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ github.token }}
          parallel-finished: true
          carryforward: "chunking,embedding,ingestion,orchestrator,parsing,reporting,summarization,error-reporting"