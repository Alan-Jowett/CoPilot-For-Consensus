# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Copilot-for-Consensus contributors

services:
  ingestion:
    image: copilot-ingestion:latest
    build:
      context: .
      dockerfile: ./ingestion/Dockerfile
    environment:
      - STORAGE_PATH=/data/raw_archives
      - METRICS_BACKEND=${METRICS_BACKEND:-prometheus_pushgateway}
      - MESSAGE_BUS_HOST=messagebus
      - MESSAGE_BUS_PORT=5672
      - PROMETHEUS_PUSHGATEWAY=${PROMETHEUS_PUSHGATEWAY:-pushgateway:9091}
    volumes:
      - raw_archives:/data/raw_archives
    ports:
      - "8000:8000"
    depends_on:
      - messagebus
      - monitoring
      - pushgateway
    restart: "no"
    profiles:
      - manual

  parsing:
    image: copilot-parsing:latest
    build:
      context: ./parsing
    environment:
      - STORAGE_PATH=/data/parsed_json
    volumes:
      - parsed_json:/data/parsed_json
    restart: unless-stopped

  chunking:
    image: copilot-chunking:latest
    build:
      context: ./chunking
    depends_on:
      - parsing
    restart: unless-stopped

  embedding:
    image: copilot-embedding:latest
    build:
      context: ./embedding
    environment:
      - VECTOR_DB_HOST=vectorstore
      - EMBEDDING_BACKEND=${EMBEDDING_BACKEND:-sentencetransformers}
      - OLLAMA_HOST=${OLLAMA_HOST:-http://ollama:11434}
    depends_on:
      - chunking
    restart: unless-stopped

  vectorstore:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
    volumes:
      - vector_data:/qdrant/storage
    restart: unless-stopped

  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped
    # Note: Pull models after startup with: docker compose exec ollama ollama pull mistral

  orchestrator:
    image: copilot-orchestrator:latest
    build:
      context: ./orchestrator
    environment:
      - VECTOR_DB_HOST=vectorstore
      - DOC_DB_HOST=documentdb
      - LLM_BACKEND=${LLM_BACKEND:-local}
      - OLLAMA_HOST=${OLLAMA_HOST:-http://ollama:11434}
      - AZURE_OPENAI_KEY=${AZURE_OPENAI_KEY:-}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT:-}
    depends_on:
      - embedding
      - vectorstore
      - documentdb
      - ollama
    restart: unless-stopped

  summarization:
    image: copilot-summarization:latest
    build:
      context: ./summarization
    depends_on:
      - orchestrator
    restart: unless-stopped

  reporting:
    image: copilot-reporting:latest
    build:
      context: ./reporting
    ports:
      - "8080:8080"
    depends_on:
      - summarization
    restart: unless-stopped

  documentdb:
    image: mongo:7.0
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME:-root}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD:-example}
    healthcheck:
      test: ["CMD", "mongosh", "mongodb://localhost:27017/admin", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped

  db-init:
    image: mongo:7.0
    depends_on:
      documentdb:
        condition: service_healthy
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME:-root}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD:-example}
      - MONGO_APP_DB=${MONGO_APP_DB:-copilot}
    volumes:
      - ./infra/init:/init:ro
      - ./documents/schemas:/schemas:ro
    entrypoint: ["/bin/bash", "-c"]
    command:
      - >-
        mongosh
        "mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@documentdb:27017/admin"
        /init/mongo-init.js
    restart: "no"

  db-validate:
    image: mongo:7.0
    depends_on:
      documentdb:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME:-root}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD:-example}
      - MONGO_APP_DB=${MONGO_APP_DB:-copilot}
    volumes:
      - ./infra/test:/test:ro
      - ./documents/schemas:/schemas:ro
    entrypoint: ["/bin/bash", "-c"]
    command:
      - >-
        mongosh
        "mongodb://${MONGO_INITDB_ROOT_USERNAME}:${MONGO_INITDB_ROOT_PASSWORD}@documentdb:27017/admin"
        /test/validate-mongo.js
    restart: "no"

  messagebus:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
    restart: unless-stopped

  monitoring:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    restart: unless-stopped

  pushgateway:
    image: prom/pushgateway:latest
    ports:
      - "9091:9091"
    restart: unless-stopped

volumes:
  raw_archives:
  parsed_json:
  vector_data:
  mongo_data:
  prometheus_data:
  ollama_data:
