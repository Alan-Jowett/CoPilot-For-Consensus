# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Copilot-for-Consensus contributors

services:
  # Infrastructure services
  db-init:
    image: mongo:7.0
    depends_on:
      documentdb:
        condition: service_healthy
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${DOC_DB_ADMIN_USERNAME:-root}
      - MONGO_INITDB_ROOT_PASSWORD=${DOC_DB_ADMIN_PASSWORD:-example}
      - MONGO_APP_DB=${MONGO_APP_DB:-copilot}
    volumes:
      - ./infra/init:/init:ro
      - ./documents/schemas:/schemas:ro
    entrypoint: ["/bin/bash", "-c"]
    command:
      - >-
        mongosh
        "mongodb://${DOC_DB_ADMIN_USERNAME}:${DOC_DB_ADMIN_PASSWORD}@documentdb:27017/admin"
        /init/mongo-init.js
    restart: "no"

  db-validate:
    image: mongo:7.0
    depends_on:
      documentdb:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${DOC_DB_ADMIN_USERNAME:-root}
      - MONGO_INITDB_ROOT_PASSWORD=${DOC_DB_ADMIN_PASSWORD:-example}
      - MONGO_APP_DB=${MONGO_APP_DB:-copilot}
    volumes:
      - ./infra/test:/test:ro
      - ./documents/schemas:/schemas:ro
    entrypoint: ["/bin/bash", "-c"]
    command:
      - >-
        mongosh
        "mongodb://${DOC_DB_ADMIN_USERNAME}:${DOC_DB_ADMIN_PASSWORD}@documentdb:27017/admin"
        /test/validate-mongo.js
    restart: "no"

  documentdb:
    image: mongo:7.0
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${DOC_DB_ADMIN_USERNAME:-root}
      - MONGO_INITDB_ROOT_PASSWORD=${DOC_DB_ADMIN_PASSWORD:-example}
    healthcheck:
      test: ["CMD", "mongosh", "mongodb://localhost:27017/admin", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infra/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
      - ./infra/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards
      - ./infra/grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      monitoring:
        condition: service_healthy
      loki:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 60s
    restart: unless-stopped

  loki:
    image: grafana/loki:latest
    ports:
      - "3100:3100"
    volumes:
      - ./infra/loki/loki-config.yml:/etc/loki/local-config.yaml
      - loki_data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    # Note: grafana/loki image is distroless and lacks a shell and http tools,
    # so we cannot run an in-container HTTP healthcheck.
    restart: unless-stopped

  messagebus:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - ./infra/rabbitmq/definitions.json:/etc/rabbitmq/definitions.json:ro
      - ./infra/rabbitmq/validate-rabbitmq.sh:/validate-rabbitmq.sh:ro
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER:-guest}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS:-guest}
      - RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS=-rabbitmq_management load_definitions "/etc/rabbitmq/definitions.json"
    healthcheck:
      # Ensure the node is up, AMQP listener is accepting connections, AND copilot.events exchange exists
      test: ["CMD-SHELL", "rabbitmq-diagnostics -q ping && rabbitmq-diagnostics -q check_port_connectivity && sh /validate-rabbitmq.sh"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s
    restart: unless-stopped

  monitoring:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./infra/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9090/-/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s
    restart: unless-stopped

  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'echo > /dev/tcp/127.0.0.1/11434' "]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s
    restart: unless-stopped

  ollama-validate:
    image: curlimages/curl:8.10.1
    depends_on:
      ollama:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - >-
        for i in $$(seq 1 40); do
          code=$$(curl -s -o /dev/null -w "%{http_code}" http://ollama:11434/api/tags || echo 0);
          if [ "$$code" -ge 200 ] && [ "$$code" -lt 500 ]; then echo "Ollama OK ($$code)"; exit 0; fi;
          echo "Waiting for Ollama ($$code)"; sleep 3;
        done; echo "Ollama validation failed"; exit 1
    restart: "no"

  # WARNING: The Promtail service mounts the Docker socket (/var/run/docker.sock) with read-only access.
  # This is required for Promtail to discover and label logs from Docker containers.
  # However, even read-only access to the Docker socket can be a security risk, as it allows querying
  # information about all containers on the host. This configuration is intended for development/local
  # use only. For production deployments, REMOVE or restrict this mount and consider alternative log
  # collection strategies. See: https://docs.docker.com/engine/security/#docker-daemon-attack-surface
  promtail:
    image: grafana/promtail:latest
    volumes:
      - ./infra/promtail/promtail-config.yml:/etc/promtail/config.yml
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      loki:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'echo > /dev/tcp/127.0.0.1/9080' "]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s
    restart: unless-stopped

  pushgateway:
    image: prom/pushgateway:latest
    ports:
      - "9091:9091"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9091/-/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s
    restart: unless-stopped

  vectorstore:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
    volumes:
      - vector_data:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'echo > /dev/tcp/127.0.0.1/6333' "]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s
    restart: unless-stopped

  vectorstore-validate:
    image: curlimages/curl:8.10.1
    depends_on:
      vectorstore:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - >-
        for i in $$(seq 1 40); do
          code=$$(curl -s -o /dev/null -w "%{http_code}" http://vectorstore:6333/collections || echo 0);
          if [ "$$code" -ge 200 ] && [ "$$code" -lt 500 ]; then echo "Qdrant OK ($$code)"; exit 0; fi;
          echo "Waiting for Qdrant ($$code)"; sleep 3;
        done; echo "Qdrant validation failed"; exit 1
    restart: "no"

  # Application services
  chunking:
    image: copilot-chunking:latest
    build:
      context: .
      dockerfile: ./chunking/Dockerfile
    environment:
      - SCHEMA_DIR=/app/documents/schemas/configs
      - MESSAGE_BUS_TYPE=rabbitmq
      - MESSAGE_BUS_HOST=messagebus
      - MESSAGE_BUS_PORT=5672
      - MESSAGE_BUS_USER=${RABBITMQ_DEFAULT_USER:-guest}
      - MESSAGE_BUS_PASSWORD=${RABBITMQ_DEFAULT_PASS:-guest}
      - DOC_STORE_TYPE=mongodb
      - DOC_DB_HOST=documentdb
      - DOC_DB_PORT=27017
      - DOC_DB_NAME=copilot
      - DOC_DB_USER=${DOC_DB_ADMIN_USERNAME:-root}
      - DOC_DB_PASSWORD=${DOC_DB_ADMIN_PASSWORD:-example}
      - METRICS_BACKEND=${METRICS_BACKEND:-prometheus_pushgateway}
      - ERROR_REPORTER_TYPE=console
    depends_on:
      messagebus:
        condition: service_healthy
      documentdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s
    restart: unless-stopped

  embedding:
    image: copilot-embedding:latest
    build:
      context: .
      dockerfile: ./embedding/Dockerfile
    environment:
      - SCHEMA_DIR=/app/documents/schemas/configs
      - MESSAGE_BUS_TYPE=rabbitmq
      - MESSAGE_BUS_HOST=messagebus
      - MESSAGE_BUS_PORT=5672
      - MESSAGE_BUS_USER=${RABBITMQ_DEFAULT_USER:-guest}
      - MESSAGE_BUS_PASSWORD=${RABBITMQ_DEFAULT_PASS:-guest}
      - DOC_STORE_TYPE=mongodb
      - DOC_DB_HOST=documentdb
      - DOC_DB_PORT=27017
      - DOC_DB_NAME=copilot
      - DOC_DB_USER=${DOC_DB_ADMIN_USERNAME:-root}
      - DOC_DB_PASSWORD=${DOC_DB_ADMIN_PASSWORD:-example}
      - VECTOR_STORE_TYPE=qdrant
      - VECTOR_DB_HOST=vectorstore
      - VECTOR_DB_PORT=6333
      - EMBEDDING_BACKEND=${EMBEDDING_BACKEND:-sentencetransformers}
      - OLLAMA_HOST=http://ollama:11434
      - METRICS_BACKEND=${METRICS_BACKEND:-prometheus_pushgateway}
      - ERROR_REPORTER_TYPE=console
    depends_on:
      messagebus:
        condition: service_healthy
      documentdb:
        condition: service_healthy
      vectorstore:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s
    restart: unless-stopped

  # WARNING: The error-reporting service has NO authentication or authorization.
  # Do NOT expose this service to untrusted networks or in production environments.
  # This is intended for local development only. See error-reporting/README.md for details.
  # WARNING: The error-reporting service has NO authentication or authorization.
  # Do NOT expose this service to untrusted networks or in production environments.
  # For local development only. See README for details.
  error-reporting:
    image: copilot-error-reporting:latest
    build:
      context: .
      dockerfile: ./error-reporting/Dockerfile
    environment:
      - SCHEMA_DIR=/app/documents/schemas/configs
    ports:
      - "127.0.0.1:8081:8081"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8081/')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  ingestion:
    image: copilot-ingestion:latest
    build:
      context: .
      dockerfile: ./ingestion/Dockerfile
    environment:
      - SCHEMA_DIR=/app/documents/schemas/configs
      - STORAGE_PATH=/data/raw_archives
      - MESSAGE_BUS_TYPE=rabbitmq
      - MESSAGE_BUS_HOST=messagebus
      - MESSAGE_BUS_PORT=5672
      - MESSAGE_BUS_USER=${RABBITMQ_DEFAULT_USER:-guest}
      - MESSAGE_BUS_PASSWORD=${RABBITMQ_DEFAULT_PASS:-guest}
      - METRICS_BACKEND=${METRICS_BACKEND:-prometheus_pushgateway}
      - PROMETHEUS_PUSHGATEWAY=pushgateway:9091
      - ERROR_REPORTER_TYPE=console
      - DOCUMENT_STORE_TYPE=mongodb
      - DOC_DB_HOST=documentdb
      - DOC_DB_PORT=27017
      - DOC_DB_NAME=copilot
      - DOC_DB_USER=${DOC_DB_ADMIN_USERNAME:-root}
      - DOC_DB_PASSWORD=${DOC_DB_ADMIN_PASSWORD:-example}
    volumes:
      - raw_archives:/data/raw_archives
    ports:
      - "8000:8000"
    depends_on:
      messagebus:
        condition: service_healthy
      monitoring:
        condition: service_healthy
      pushgateway:
        condition: service_healthy
      documentdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s
    restart: "no"

  orchestrator:
    image: copilot-orchestrator:latest
    build:
      context: .
      dockerfile: ./orchestrator/Dockerfile
    environment:
      - SCHEMA_DIR=/app/documents/schemas/configs
      - MESSAGE_BUS_TYPE=rabbitmq
      - MESSAGE_BUS_HOST=messagebus
      - MESSAGE_BUS_PORT=5672
      - MESSAGE_BUS_USER=${RABBITMQ_DEFAULT_USER:-guest}
      - MESSAGE_BUS_PASSWORD=${RABBITMQ_DEFAULT_PASS:-guest}
      - DOC_STORE_TYPE=mongodb
      - DOC_DB_HOST=documentdb
      - DOC_DB_PORT=27017
      - DOC_DB_NAME=copilot
      - DOC_DB_USER=${DOC_DB_ADMIN_USERNAME:-root}
      - DOC_DB_PASSWORD=${DOC_DB_ADMIN_PASSWORD:-example}
      - VECTOR_DB_HOST=vectorstore
      - VECTOR_DB_PORT=6333
      - LLM_BACKEND=${LLM_BACKEND:-local}
      - OLLAMA_HOST=http://ollama:11434
      - AZURE_OPENAI_KEY=${AZURE_OPENAI_KEY:-}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT:-}
      - METRICS_BACKEND=${METRICS_BACKEND:-prometheus_pushgateway}
      - ERROR_REPORTER_TYPE=console
    depends_on:
      messagebus:
        condition: service_healthy
      documentdb:
        condition: service_healthy
      vectorstore:
        condition: service_healthy
      vectorstore-validate:
        condition: service_completed_successfully
      ollama-validate:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s
    restart: unless-stopped

  parsing:
    image: copilot-parsing:latest
    build:
      context: .
      dockerfile: ./parsing/Dockerfile
    environment:
      - SCHEMA_DIR=/app/documents/schemas/configs
      - MESSAGE_BUS_TYPE=rabbitmq
      - MESSAGE_BUS_HOST=messagebus
      - MESSAGE_BUS_PORT=5672
      - MESSAGE_BUS_USER=${RABBITMQ_DEFAULT_USER:-guest}
      - MESSAGE_BUS_PASSWORD=${RABBITMQ_DEFAULT_PASS:-guest}
      - DOC_STORE_TYPE=mongodb
      - DOC_DB_HOST=documentdb
      - DOC_DB_PORT=27017
      - DOC_DB_NAME=copilot
      - DOC_DB_USER=${DOC_DB_ADMIN_USERNAME:-root}
      - DOC_DB_PASSWORD=${DOC_DB_ADMIN_PASSWORD:-example}
      - METRICS_BACKEND=${METRICS_BACKEND:-prometheus_pushgateway}
      - ERROR_REPORTER_TYPE=console
    volumes:
      - raw_archives:/data/raw_archives:ro
    depends_on:
      messagebus:
        condition: service_healthy
      documentdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  reporting:
    image: copilot-reporting:latest
    build:
      context: .
      dockerfile: ./reporting/Dockerfile
    environment:
      - SCHEMA_DIR=/app/documents/schemas/configs
      - MESSAGE_BUS_TYPE=rabbitmq
      - MESSAGE_BUS_HOST=messagebus
      - MESSAGE_BUS_PORT=5672
      - MESSAGE_BUS_USER=${RABBITMQ_DEFAULT_USER:-guest}
      - MESSAGE_BUS_PASSWORD=${RABBITMQ_DEFAULT_PASS:-guest}
      - DOC_STORE_TYPE=mongodb
      - DOC_DB_HOST=documentdb
      - DOC_DB_PORT=27017
      - DOC_DB_NAME=copilot
      - DOC_DB_USER=${DOC_DB_ADMIN_USERNAME:-root}
      - DOC_DB_PASSWORD=${DOC_DB_ADMIN_PASSWORD:-example}
      - METRICS_BACKEND=${METRICS_BACKEND:-prometheus_pushgateway}
      - ERROR_REPORTER_TYPE=console
      - HTTP_PORT=8080
    ports:
      - "8080:8080"
    depends_on:
      messagebus:
        condition: service_healthy
      documentdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s
    restart: unless-stopped

  summarization:
    image: copilot-summarization:latest
    build:
      context: .
      dockerfile: ./summarization/Dockerfile
    environment:
      - SCHEMA_DIR=/app/documents/schemas/configs
      - MESSAGE_BUS_TYPE=rabbitmq
      - MESSAGE_BUS_HOST=messagebus
      - MESSAGE_BUS_PORT=5672
      - MESSAGE_BUS_USER=${RABBITMQ_DEFAULT_USER:-guest}
      - MESSAGE_BUS_PASSWORD=${RABBITMQ_DEFAULT_PASS:-guest}
      - DOC_STORE_TYPE=mongodb
      - DOC_DB_HOST=documentdb
      - DOC_DB_PORT=27017
      - DOC_DB_NAME=copilot
      - DOC_DB_USER=${DOC_DB_ADMIN_USERNAME:-root}
      - DOC_DB_PASSWORD=${DOC_DB_ADMIN_PASSWORD:-example}
      - VECTOR_STORE_TYPE=qdrant
      - VECTOR_DB_HOST=vectorstore
      - VECTOR_DB_PORT=6333
      - LLM_BACKEND=${LLM_BACKEND:-mock}
      - LLM_MODEL=${LLM_MODEL:-mistral}
      - OLLAMA_HOST=http://ollama:11434
      - METRICS_BACKEND=${METRICS_BACKEND:-prometheus_pushgateway}
      - ERROR_REPORTER_TYPE=console
    depends_on:
      messagebus:
        condition: service_healthy
      documentdb:
        condition: service_healthy
      vectorstore:
        condition: service_healthy
      vectorstore-validate:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s
    restart: unless-stopped

volumes:
  raw_archives:
  vector_data:
  mongo_data:
  prometheus_data:
  grafana_data:
  loki_data:
  ollama_data:
