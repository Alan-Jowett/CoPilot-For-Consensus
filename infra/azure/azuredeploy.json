{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "description": "Azure Resource Manager template for deploying Copilot for Consensus architecture with managed identity support",
    "license": "MIT",
    "copyright": "Copyright (c) 2025 Copilot-for-Consensus contributors"
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "projectName": {
      "type": "string",
      "defaultValue": "copilot",
      "minLength": 3,
      "maxLength": 15,
      "metadata": {
        "description": "Prefix for resource names. Must be 3-15 characters."
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "dev",
      "allowedValues": [
        "dev",
        "staging",
        "prod"
      ],
      "metadata": {
        "description": "Environment name (dev, staging, prod)"
      }
    },
    "deploymentMode": {
      "type": "string",
      "defaultValue": "admin",
      "allowedValues": [
        "admin",
        "managedIdentity"
      ],
      "metadata": {
        "description": "Deployment mode: admin (manual) or managedIdentity (automated)"
      }
    },
    "containerRegistryName": {
      "type": "string",
      "defaultValue": "ghcr.io/alan-jowett/copilot-for-consensus",
      "metadata": {
        "description": "Container registry URL (e.g., ghcr.io/alan-jowett/copilot-for-consensus)"
      }
    },
    "containerImageTag": {
      "type": "string",
      "defaultValue": "latest",
      "metadata": {
        "description": "Container image tag to deploy"
      }
    },
    "cosmosDbAccountName": {
      "type": "string",
      "defaultValue": "[format('{0}-cosmos-{1}', parameters('projectName'), variables('uniqueSuffix'))]",
      "metadata": {
        "description": "Cosmos DB account name"
      }
    },
    "cosmosDbDatabaseName": {
      "type": "string",
      "defaultValue": "copilot",
      "metadata": {
        "description": "Cosmos DB database name"
      }
    },
    "cosmosDbContainerName": {
      "type": "string",
      "defaultValue": "documents",
      "metadata": {
        "description": "Cosmos DB container name"
      }
    },
    "cosmosDbPartitionKey": {
      "type": "string",
      "defaultValue": "/collection",
      "metadata": {
        "description": "Cosmos DB partition key path"
      }
    },
    "cosmosDbThroughput": {
      "type": "int",
      "defaultValue": 400,
      "minValue": 400,
      "maxValue": 1000000,
      "metadata": {
        "description": "Cosmos DB container throughput in RU/s (Request Units per second)"
      }
    },
    "useManagedIdentityForServiceBus": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Use Azure Managed Identity for Service Bus authentication (passwordless). When true, serviceBusNamespace is required and serviceBusConnectionString is not used."
      }
    },
    "serviceBusNamespace": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Azure Service Bus fully qualified namespace (e.g., 'mynamespace.servicebus.windows.net'). Required when useManagedIdentityForServiceBus is true."
      }
    },
    "serviceBusResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Azure Service Bus namespace resource ID in format: '/subscriptions/{subscription-id}/resourceGroups/{resource-group}/providers/Microsoft.ServiceBus/namespaces/{namespace-name}'. Required when useManagedIdentityForServiceBus is true for RBAC role assignments."
      }
    },
    "serviceBusConnectionString": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Azure Service Bus connection string. Required when useManagedIdentityForServiceBus is false."
      }
    },
    "storageAccountConnectionString": {
      "type": "securestring",
      "metadata": {
        "description": "Azure Storage Account connection string"
      }
    },
    "createNewIdentities": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Whether to create new managed identities or use existing ones"
      }
    },
    "existingIdentityResourceIds": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Existing identity resource IDs if createNewIdentities is false"
      }
    },
    "vnetName": {
      "type": "string",
      "defaultValue": "[format('{0}-vnet', parameters('projectName'))]",
      "metadata": {
        "description": "Virtual network name"
      }
    },
    "vnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.0.0/16",
      "metadata": {
        "description": "Virtual network address prefix"
      }
    },
    "subnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.0.0.0/23",
      "metadata": {
        "description": "Container Apps subnet address prefix"
      }
    },
    "llmBackend": {
      "type": "string",
      "defaultValue": "azure",
      "allowedValues": [
        "local",
        "azure",
        "mock"
      ],
      "metadata": {
        "description": "LLM backend to use (local for Ollama, azure for Azure OpenAI)"
      }
    },
    "azureOpenAIEndpoint": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Azure OpenAI endpoint URL (required if llmBackend is azure)"
      }
    },
    "azureOpenAIKey": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Azure OpenAI API key (required if llmBackend is azure)"
      }
    }
  },
  "variables": {
    "uniqueSuffix": "[uniqueString(resourceGroup().id)]",
    "containerAppsEnvironmentName": "[format('{0}-env-{1}', parameters('projectName'), variables('uniqueSuffix'))]",
    "logAnalyticsWorkspaceName": "[format('{0}-logs-{1}', parameters('projectName'), variables('uniqueSuffix'))]",
    "applicationInsightsName": "[format('{0}-insights-{1}', parameters('projectName'), variables('uniqueSuffix'))]",
    "keyVaultName": "[format('{0}kv{1}', parameters('projectName'), variables('uniqueSuffix'))]",
    "storageAccountName": "[format('{0}st{1}', replace(parameters('projectName'), '-', ''), variables('uniqueSuffix'))]",
    
    "validateServiceBusResourceIdFormat": "[if(parameters('useManagedIdentityForServiceBus'), if(equals(length(split(parameters('serviceBusResourceId'), '/')), 9), true(), json('null')), true())]",
    
    "services": [
      {
        "name": "ingestion",
        "image": "[format('{0}/ingestion:{1}', parameters('containerRegistryName'), parameters('containerImageTag'))]",
        "cpu": "0.5",
        "memory": "1Gi",
        "minReplicas": 1,
        "maxReplicas": 3,
        "port": 8001
      },
      {
        "name": "parsing",
        "image": "[format('{0}/parsing:{1}', parameters('containerRegistryName'), parameters('containerImageTag'))]",
        "cpu": "0.5",
        "memory": "1Gi",
        "minReplicas": 1,
        "maxReplicas": 5,
        "port": 8000
      },
      {
        "name": "chunking",
        "image": "[format('{0}/chunking:{1}', parameters('containerRegistryName'), parameters('containerImageTag'))]",
        "cpu": "0.5",
        "memory": "1Gi",
        "minReplicas": 1,
        "maxReplicas": 5,
        "port": 8000
      },
      {
        "name": "embedding",
        "image": "[format('{0}/embedding:{1}', parameters('containerRegistryName'), parameters('containerImageTag'))]",
        "cpu": "1.0",
        "memory": "2Gi",
        "minReplicas": 1,
        "maxReplicas": 5,
        "port": 8000
      },
      {
        "name": "orchestrator",
        "image": "[format('{0}/orchestrator:{1}', parameters('containerRegistryName'), parameters('containerImageTag'))]",
        "cpu": "0.5",
        "memory": "1Gi",
        "minReplicas": 1,
        "maxReplicas": 3,
        "port": 8000
      },
      {
        "name": "summarization",
        "image": "[format('{0}/summarization:{1}', parameters('containerRegistryName'), parameters('containerImageTag'))]",
        "cpu": "1.0",
        "memory": "2Gi",
        "minReplicas": 1,
        "maxReplicas": 5,
        "port": 8000
      },
      {
        "name": "reporting",
        "image": "[format('{0}/reporting:{1}', parameters('containerRegistryName'), parameters('containerImageTag'))]",
        "cpu": "0.5",
        "memory": "1Gi",
        "minReplicas": 1,
        "maxReplicas": 5,
        "port": 8080
      },
      {
        "name": "auth",
        "image": "[format('{0}/auth:{1}', parameters('containerRegistryName'), parameters('containerImageTag'))]",
        "cpu": "0.5",
        "memory": "1Gi",
        "minReplicas": 1,
        "maxReplicas": 3,
        "port": 8090
      },
      {
        "name": "ui",
        "image": "[format('{0}/ui:{1}', parameters('containerRegistryName'), parameters('containerImageTag'))]",
        "cpu": "0.25",
        "memory": "0.5Gi",
        "minReplicas": 1,
        "maxReplicas": 5,
        "port": 80
      },
      {
        "name": "gateway",
        "image": "[format('{0}/gateway:{1}', parameters('containerRegistryName'), parameters('containerImageTag'))]",
        "cpu": "0.5",
        "memory": "0.5Gi",
        "minReplicas": 1,
        "maxReplicas": 3,
        "port": 8080
      }
    ],
    
    "roleDefinitions": {
      "KeyVaultSecretsUser": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
      "StorageBlobDataContributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
      "ServiceBusDataSender": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '69a216fc-b8fb-44d4-bc22-1f3c7cd27a98')]",
      "ServiceBusDataReceiver": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4f6d3b9b-027b-4f4c-9142-0e5a2a2247e0')]",
      "CosmosDbDataContributor": "00000000-0000-0000-0000-000000000002"
    },
    
    "serviceBusRoleAssignments": [
      {
        "serviceName": "ingestion",
        "roles": ["ServiceBusDataSender"]
      },
      {
        "serviceName": "parsing",
        "roles": ["ServiceBusDataSender", "ServiceBusDataReceiver"]
      },
      {
        "serviceName": "chunking",
        "roles": ["ServiceBusDataSender", "ServiceBusDataReceiver"]
      },
      {
        "serviceName": "embedding",
        "roles": ["ServiceBusDataSender", "ServiceBusDataReceiver"]
      },
      {
        "serviceName": "orchestrator",
        "roles": ["ServiceBusDataSender", "ServiceBusDataReceiver"]
      },
      {
        "serviceName": "summarization",
        "roles": ["ServiceBusDataSender", "ServiceBusDataReceiver"]
      },
      {
        "serviceName": "reporting",
        "roles": ["ServiceBusDataSender", "ServiceBusDataReceiver"]
      }
    ],
    
    "servicesUsingMessageBus": ["ingestion", "parsing", "chunking", "embedding", "orchestrator", "summarization", "reporting"]
  },
  "resources": [
    {
      "type": "Microsoft.Network/virtualNetworks",
      "apiVersion": "2023-04-01",
      "name": "[parameters('vnetName')]",
      "location": "[parameters('location')]",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[parameters('vnetAddressPrefix')]"
          ]
        },
        "subnets": [
          {
            "name": "containerapps-subnet",
            "properties": {
              "addressPrefix": "[parameters('subnetAddressPrefix')]"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2022-10-01",
      "name": "[variables('logAnalyticsWorkspaceName')]",
      "location": "[parameters('location')]",
      "properties": {
        "sku": {
          "name": "PerGB2018"
        },
        "retentionInDays": 30
      }
    },
    {
      "type": "Microsoft.Insights/components",
      "apiVersion": "2020-02-02",
      "name": "[variables('applicationInsightsName')]",
      "location": "[parameters('location')]",
      "kind": "web",
      "properties": {
        "Application_Type": "web",
        "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
      ]
    },
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2023-02-01",
      "name": "[variables('keyVaultName')]",
      "location": "[parameters('location')]",
      "properties": {
        "sku": {
          "family": "A",
          "name": "standard"
        },
        "tenantId": "[subscription().tenantId]",
        "enableRbacAuthorization": true,
        "enableSoftDelete": true,
        "softDeleteRetentionInDays": 7
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2023-01-01",
      "name": "[variables('storageAccountName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "StorageV2",
      "properties": {
        "accessTier": "Hot",
        "allowBlobPublicAccess": false,
        "supportsHttpsTrafficOnly": true,
        "minimumTlsVersion": "TLS1_2"
      }
    },
    {
      "type": "Microsoft.DocumentDB/databaseAccounts",
      "apiVersion": "2023-04-15",
      "name": "[parameters('cosmosDbAccountName')]",
      "location": "[parameters('location')]",
      "kind": "GlobalDocumentDB",
      "properties": {
        "databaseAccountOfferType": "Standard",
        "consistencyPolicy": {
          "defaultConsistencyLevel": "Session"
        },
        "locations": [
          {
            "locationName": "[parameters('location')]",
            "failoverPriority": 0,
            "isZoneRedundant": false
          }
        ],
        "enableAutomaticFailover": false,
        "enableMultipleWriteLocations": false,
        "disableKeyBasedMetadataWriteAccess": false,
        "enableFreeTier": false,
        "publicNetworkAccess": "Enabled"
      }
    },
    {
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
      "apiVersion": "2023-04-15",
      "name": "[format('{0}/{1}', parameters('cosmosDbAccountName'), parameters('cosmosDbDatabaseName'))]",
      "properties": {
        "resource": {
          "id": "[parameters('cosmosDbDatabaseName')]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName'))]"
      ]
    },
    {
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
      "apiVersion": "2023-04-15",
      "name": "[format('{0}/{1}/{2}', parameters('cosmosDbAccountName'), parameters('cosmosDbDatabaseName'), parameters('cosmosDbContainerName'))]",
      "properties": {
        "resource": {
          "id": "[parameters('cosmosDbContainerName')]",
          "partitionKey": {
            "paths": [
              "[parameters('cosmosDbPartitionKey')]"
            ],
            "kind": "Hash"
          },
          "indexingPolicy": {
            "indexingMode": "consistent",
            "automatic": true,
            "includedPaths": [
              {
                "path": "/*"
              }
            ],
            "excludedPaths": [
              {
                "path": "/\"_etag\"/?"
              }
            ]
          }
        },
        "options": {
          "throughput": "[parameters('cosmosDbThroughput')]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosDbAccountName'), parameters('cosmosDbDatabaseName'))]"
      ]
    },
    {
      "condition": "[parameters('createNewIdentities')]",
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2023-01-31",
      "name": "[format('{0}-{1}-identity', parameters('projectName'), variables('services')[copyIndex()].name)]",
      "location": "[parameters('location')]",
      "copy": {
        "name": "identityCopy",
        "count": "[length(variables('services'))]"
      }
    },
    {
      "type": "Microsoft.App/managedEnvironments",
      "apiVersion": "2023-05-01",
      "name": "[variables('containerAppsEnvironmentName')]",
      "location": "[parameters('location')]",
      "properties": {
        "appLogsConfiguration": {
          "destination": "log-analytics",
          "logAnalyticsConfiguration": {
            "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))).customerId]",
            "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName')), '2022-10-01').primarySharedKey]"
          }
        },
        "vnetConfiguration": {
          "infrastructureSubnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), 'containerapps-subnet')]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]",
        "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
      ]
    },
    {
      "type": "Microsoft.App/containerApps",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}-{1}', parameters('projectName'), variables('services')[copyIndex()].name)]",
      "location": "[parameters('location')]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[if(parameters('createNewIdentities'), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-identity', parameters('projectName'), variables('services')[copyIndex()].name)), parameters('existingIdentityResourceIds')[variables('services')[copyIndex()].name])]": {}
        }
      },
      "properties": {
        "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvironmentName'))]",
        "configuration": {
          "ingress": {
            "external": "[if(or(equals(variables('services')[copyIndex()].name, 'gateway'), equals(variables('services')[copyIndex()].name, 'ui')), true(), false())]",
            "targetPort": "[variables('services')[copyIndex()].port]",
            "transport": "http",
            "allowInsecure": false
          },
          "secrets": "[if(parameters('useManagedIdentityForServiceBus'), createArray(createObject('name', 'cosmos-key', 'value', listKeys(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName')), '2023-04-15').primaryMasterKey), createObject('name', 'storage-connection-string', 'value', parameters('storageAccountConnectionString')), createObject('name', 'azure-openai-key', 'value', if(equals(parameters('llmBackend'), 'azure'), parameters('azureOpenAIKey'), ''))), createArray(createObject('name', 'cosmos-key', 'value', listKeys(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName')), '2023-04-15').primaryMasterKey), createObject('name', 'servicebus-connection-string', 'value', parameters('serviceBusConnectionString')), createObject('name', 'storage-connection-string', 'value', parameters('storageAccountConnectionString')), createObject('name', 'azure-openai-key', 'value', if(equals(parameters('llmBackend'), 'azure'), parameters('azureOpenAIKey'), ''))))]"
        },
        "template": {
          "containers": [
            {
              "name": "[variables('services')[copyIndex()].name]",
              "image": "[variables('services')[copyIndex()].image]",
              "resources": {
                "cpu": "[json(variables('services')[copyIndex()].cpu)]",
                "memory": "[variables('services')[copyIndex()].memory]"
              },
              "env": "[concat(if(contains(variables('servicesUsingMessageBus'), variables('services')[copyIndex()].name), concat(createArray(createObject('name', 'MESSAGE_BUS_TYPE', 'value', 'azureservicebus')), if(parameters('useManagedIdentityForServiceBus'), createArray(createObject('name', 'MESSAGE_BUS_FULLY_QUALIFIED_NAMESPACE', 'value', parameters('serviceBusNamespace')), createObject('name', 'MESSAGE_BUS_USE_MANAGED_IDENTITY', 'value', 'true')), createArray(createObject('name', 'MESSAGE_BUS_CONNECTION_STRING', 'secretRef', 'servicebus-connection-string')))), createArray()), createArray(createObject('name', 'DOCUMENT_STORE_TYPE', 'value', 'azurecosmos'), createObject('name', 'COSMOS_ENDPOINT', 'value', reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName'))).documentEndpoint), createObject('name', 'COSMOS_KEY', 'secretRef', 'cosmos-key'), createObject('name', 'COSMOS_DATABASE', 'value', parameters('cosmosDbDatabaseName')), createObject('name', 'COSMOS_CONTAINER', 'value', parameters('cosmosDbContainerName')), createObject('name', 'COSMOS_PARTITION_KEY', 'value', parameters('cosmosDbPartitionKey')), createObject('name', 'STORAGE_CONNECTION_STRING', 'secretRef', 'storage-connection-string'), createObject('name', 'LLM_BACKEND', 'value', parameters('llmBackend')), createObject('name', 'AZURE_OPENAI_ENDPOINT', 'value', parameters('azureOpenAIEndpoint')), createObject('name', 'AZURE_OPENAI_KEY', 'secretRef', 'azure-openai-key'), createObject('name', 'APPLICATIONINSIGHTS_CONNECTION_STRING', 'value', reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))).ConnectionString), createObject('name', 'KEY_VAULT_URI', 'value', reference(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))).vaultUri), createObject('name', 'METRICS_BACKEND', 'value', 'applicationinsights'), createObject('name', 'ERROR_REPORTER_TYPE', 'value', 'applicationinsights')))]"
            }
          ],
          "scale": {
            "minReplicas": "[variables('services')[copyIndex()].minReplicas]",
            "maxReplicas": "[variables('services')[copyIndex()].maxReplicas]",
            "rules": [
              {
                "name": "http-scaling",
                "http": {
                  "metadata": {
                    "concurrentRequests": "10"
                  }
                }
              }
            ]
          }
        }
      },
      "copy": {
        "name": "containerAppsCopy",
        "count": "[length(variables('services'))]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvironmentName'))]",
        "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]",
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName'))]",
        "identityCopy"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(resourceGroup().id, variables('services')[copyIndex()].name, 'KeyVaultSecretsUser')]",
      "scope": "[format('Microsoft.KeyVault/vaults/{0}', variables('keyVaultName'))]",
      "properties": {
        "roleDefinitionId": "[variables('roleDefinitions').KeyVaultSecretsUser]",
        "principalId": "[if(parameters('createNewIdentities'), reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-identity', parameters('projectName'), variables('services')[copyIndex()].name))).principalId, reference(parameters('existingIdentityResourceIds')[variables('services')[copyIndex()].name], '2023-01-31').principalId)]",
        "principalType": "ServicePrincipal"
      },
      "copy": {
        "name": "keyVaultRoleAssignmentsCopy",
        "count": "[length(variables('services'))]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
        "identityCopy",
        "containerAppsCopy"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(resourceGroup().id, variables('services')[copyIndex()].name, 'StorageBlobDataContributor')]",
      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', variables('storageAccountName'))]",
      "properties": {
        "roleDefinitionId": "[variables('roleDefinitions').StorageBlobDataContributor]",
        "principalId": "[if(parameters('createNewIdentities'), reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-identity', parameters('projectName'), variables('services')[copyIndex()].name))).principalId, reference(parameters('existingIdentityResourceIds')[variables('services')[copyIndex()].name], '2023-01-31').principalId)]",
        "principalType": "ServicePrincipal"
      },
      "copy": {
        "name": "storageRoleAssignmentsCopy",
        "count": "[length(variables('services'))]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
        "identityCopy",
        "containerAppsCopy"
      ]
    },
    {
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
      "apiVersion": "2023-04-15",
      "name": "[format('{0}/{1}', parameters('cosmosDbAccountName'), guid(resourceGroup().id, variables('services')[copyIndex()].name, 'CosmosDbDataContributor'))]",
      "properties": {
        "roleDefinitionId": "[concat(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName')), '/sqlRoleDefinitions/', variables('roleDefinitions').CosmosDbDataContributor)]",
        "principalId": "[if(parameters('createNewIdentities'), reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-identity', parameters('projectName'), variables('services')[copyIndex()].name))).principalId, reference(parameters('existingIdentityResourceIds')[variables('services')[copyIndex()].name], '2023-01-31').principalId)]",
        "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName'))]"
      },
      "copy": {
        "name": "cosmosDbRoleAssignmentsCopy",
        "count": "[length(variables('services'))]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName'))]",
        "identityCopy",
        "containerAppsCopy"
      ]
    },
    {
      "condition": "[and(parameters('useManagedIdentityForServiceBus'), variables('validateServiceBusResourceIdFormat'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('serviceBusRoleAssignments-{0}', variables('serviceBusRoleAssignments')[copyIndex()].serviceName)]",
      "resourceGroup": "[split(parameters('serviceBusResourceId'), '/')[4]]",
      "properties": {
        "mode": "Incremental",
        "expressionEvaluationOptions": {
          "scope": "Inner"
        },
        "parameters": {
          "serviceBusNamespaceName": {
            "value": "[last(split(parameters('serviceBusResourceId'), '/'))]"
          },
          "principalId": {
            "value": "[if(parameters('createNewIdentities'), reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-identity', parameters('projectName'), variables('serviceBusRoleAssignments')[copyIndex()].serviceName))).principalId, reference(parameters('existingIdentityResourceIds')[variables('serviceBusRoleAssignments')[copyIndex()].serviceName], '2023-01-31').principalId)]"
          },
          "roles": {
            "value": "[variables('serviceBusRoleAssignments')[copyIndex()].roles]"
          },
          "serviceName": {
            "value": "[variables('serviceBusRoleAssignments')[copyIndex()].serviceName]"
          },
          "roleDefinitions": {
            "value": "[variables('roleDefinitions')]"
          },
          "resourceGroupId": {
            "value": "[resourceGroup().id]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "serviceBusNamespaceName": {
              "type": "string"
            },
            "principalId": {
              "type": "string"
            },
            "roles": {
              "type": "array"
            },
            "serviceName": {
              "type": "string"
            },
            "roleDefinitions": {
              "type": "object"
            },
            "resourceGroupId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "copy": {
                "name": "roleAssignmentCopy",
                "count": "[length(parameters('roles'))]"
              },
              "type": "Microsoft.ServiceBus/namespaces/providers/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[format('{0}/Microsoft.Authorization/{1}', parameters('serviceBusNamespaceName'), guid(parameters('resourceGroupId'), parameters('serviceName'), parameters('roles')[copyIndex()]))]",
              "properties": {
                "roleDefinitionId": "[parameters('roleDefinitions')[parameters('roles')[copyIndex()]]]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "copy": {
        "name": "serviceBusRoleAssignmentsCopy",
        "count": "[length(variables('serviceBusRoleAssignments'))]"
      },
      "dependsOn": [
        "identityCopy",
        "containerAppsCopy"
      ]
    }
  ],
  "outputs": {
    "containerAppsEnvironmentId": {
      "type": "string",
      "value": "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvironmentName'))]"
    },
    "applicationInsightsInstrumentationKey": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))).InstrumentationKey]"
    },
    "keyVaultUri": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))).vaultUri]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[variables('storageAccountName')]"
    },
    "cosmosDbEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName'))).documentEndpoint]"
    },
    "cosmosDbDatabaseName": {
      "type": "string",
      "value": "[parameters('cosmosDbDatabaseName')]"
    },
    "cosmosDbContainerName": {
      "type": "string",
      "value": "[parameters('cosmosDbContainerName')]"
    },
    "gatewayUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.App/containerApps', format('{0}-gateway', parameters('projectName')))).configuration.ingress.fqdn]"
    },
    "managedIdentities": {
      "type": "object",
      "value": {
        "copy": [
          {
            "name": "identities",
            "count": "[length(variables('services'))]",
            "input": {
              "serviceName": "[variables('services')[copyIndex('identities')].name]",
              "identityResourceId": "[if(parameters('createNewIdentities'), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-identity', parameters('projectName'), variables('services')[copyIndex('identities')].name)), if(contains(parameters('existingIdentityResourceIds'), variables('services')[copyIndex('identities')].name), parameters('existingIdentityResourceIds')[variables('services')[copyIndex('identities')].name], ''))]"
            }
          }
        ]
      }
    }
  }
}
