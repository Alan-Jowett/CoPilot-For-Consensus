{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "9908772915155138351"
    },
    "description": "Main orchestration template for Copilot for Consensus Azure deployment",
    "author": "Copilot-for-Consensus Team"
  },
  "parameters": {
    "projectName": {
      "type": "string",
      "defaultValue": "copilot",
      "minLength": 3,
      "maxLength": 15
    },
    "environment": {
      "type": "string",
      "defaultValue": "dev",
      "allowedValues": [
        "dev",
        "test",
        "prod"
      ]
    },
    "location": {
      "type": "string",
      "defaultValue": "westus"
    },
    "containerImageTag": {
      "type": "string",
      "defaultValue": "latest"
    },
    "deployAzureOpenAI": {
      "type": "bool",
      "defaultValue": true
    },
    "azureOpenAISku": {
      "type": "string",
      "defaultValue": "S0",
      "allowedValues": [
        "S0",
        "S1",
        "S2"
      ]
    },
    "cosmosDbAutoscaleMinRu": {
      "type": "int",
      "defaultValue": 400,
      "minValue": 400,
      "maxValue": 1000000
    },
    "cosmosDbAutoscaleMaxRu": {
      "type": "int",
      "defaultValue": 1000,
      "minValue": 400,
      "maxValue": 1000000
    },
    "serviceBusSku": {
      "type": "string",
      "defaultValue": "Standard",
      "allowedValues": [
        "Standard",
        "Premium"
      ]
    },
    "enableMultiRegionCosmos": {
      "type": "bool",
      "defaultValue": false
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "environment": "[parameters('environment')]",
        "project": "copilot-for-consensus",
        "createdBy": "bicep"
      }
    }
  },
  "variables": {
    "services": [
      "ingestion",
      "parsing",
      "chunking",
      "embedding",
      "orchestrator",
      "summarization",
      "reporting",
      "auth",
      "ui",
      "gateway"
    ],
    "uniqueSuffix": "[uniqueString(resourceGroup().id)]",
    "keyVaultName": "[format('{0}-kv-{1}', parameters('projectName'), variables('uniqueSuffix'))]",
    "identityPrefix": "[format('{0}-{1}', parameters('projectName'), parameters('environment'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "identitiesDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "identityPrefix": {
            "value": "[variables('identityPrefix')]"
          },
          "services": {
            "value": "[variables('services')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11565807037465105558"
            },
            "description": "Module to create user-assigned managed identities for all microservices"
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "identityPrefix": {
              "type": "string"
            },
            "services": {
              "type": "array"
            },
            "tags": {
              "type": "object"
            }
          },
          "resources": [
            {
              "copy": {
                "name": "managedIdentities",
                "count": "[length(parameters('services'))]"
              },
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[copyIndex()])]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "identities": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('services'))]",
                "input": {
                  "service": "[parameters('services')[copyIndex()]]",
                  "resourceId": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[copyIndex()]))]",
                  "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[copyIndex()])), '2023-01-31').principalId]"
                }
              }
            },
            "identityPrincipalIds": {
              "type": "array",
              "value": [
                "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[0])), '2023-01-31').principalId]",
                "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[1])), '2023-01-31').principalId]",
                "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[2])), '2023-01-31').principalId]",
                "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[3])), '2023-01-31').principalId]",
                "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[4])), '2023-01-31').principalId]",
                "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[5])), '2023-01-31').principalId]",
                "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[6])), '2023-01-31').principalId]",
                "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[7])), '2023-01-31').principalId]",
                "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[8])), '2023-01-31').principalId]",
                "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[9])), '2023-01-31').principalId]"
              ]
            },
            "identityResourceIds": {
              "type": "object",
              "value": {
                "ingestion": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[0]))]",
                "parsing": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[1]))]",
                "chunking": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[2]))]",
                "embedding": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[3]))]",
                "orchestrator": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[4]))]",
                "summarization": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[5]))]",
                "reporting": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[6]))]",
                "auth": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[7]))]",
                "ui": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[8]))]",
                "gateway": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-{1}-id', parameters('identityPrefix'), parameters('services')[9]))]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "keyVaultDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "keyVaultName": {
            "value": "[variables('keyVaultName')]"
          },
          "tenantId": {
            "value": "[subscription().tenantId]"
          },
          "managedIdentityPrincipalIds": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identitiesDeployment'), '2025-04-01').outputs.identityPrincipalIds.value]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "15498998610448959755"
            },
            "description": "Module to create Azure Key Vault and assign managed identity access policies"
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "keyVaultName": {
              "type": "string"
            },
            "tenantId": {
              "type": "string"
            },
            "managedIdentityPrincipalIds": {
              "type": "array"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "copy": [
              {
                "name": "accessPoliciesArray",
                "count": "[length(parameters('managedIdentityPrincipalIds'))]",
                "input": {
                  "objectId": "[parameters('managedIdentityPrincipalIds')[copyIndex('accessPoliciesArray')]]",
                  "tenantId": "[parameters('tenantId')]",
                  "permissions": {
                    "secrets": [
                      "get",
                      "list"
                    ],
                    "keys": [],
                    "certificates": []
                  }
                }
              }
            ]
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "enabledForDeployment": true,
                "enabledForTemplateDeployment": true,
                "enabledForDiskEncryption": false,
                "tenantId": "[parameters('tenantId')]",
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "accessPolicies": [],
                "publicNetworkAccess": "Enabled"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/accessPolicies",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'add')]",
              "properties": {
                "accessPolicies": "[variables('accessPoliciesArray')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            }
          ],
          "outputs": {
            "keyVaultUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri]"
            },
            "keyVaultId": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
            },
            "keyVaultName": {
              "type": "string",
              "value": "[parameters('keyVaultName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'identitiesDeployment')]"
      ]
    }
  ],
  "outputs": {
    "keyVaultUri": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyVaultDeployment'), '2025-04-01').outputs.keyVaultUri.value]"
    },
    "keyVaultName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyVaultDeployment'), '2025-04-01').outputs.keyVaultName.value]"
    },
    "managedIdentities": {
      "type": "array",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'identitiesDeployment'), '2025-04-01').outputs.identities.value]"
    },
    "resourceGroupName": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "location": {
      "type": "string",
      "value": "[parameters('location')]"
    },
    "environment": {
      "type": "string",
      "value": "[parameters('environment')]"
    },
    "deploymentId": {
      "type": "string",
      "value": "[deployment().name]"
    }
  }
}