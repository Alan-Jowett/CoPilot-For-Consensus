# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Copilot-for-Consensus contributors

global:
  scrape_interval: 15s
  evaluation_interval: 15s

# Alert rules for failed queue monitoring
# NOTE: Ensure /etc/prometheus/alerts/ directory is mounted in the container.
# In Docker Compose, mount with: ./infra/prometheus/alerts:/etc/prometheus/alerts:ro
rule_files:
  - /etc/prometheus/alerts/*.yml

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['monitoring:9090']

  # Note: Services use push model (PrometheusPushGatewayMetricsCollector) and push metrics to Pushgateway.
  # They do NOT expose /metrics endpoints. Prometheus scrapes metrics from Pushgateway instead.
  # For service health endpoints, see /health on each service.

  - job_name: 'pushgateway'
    static_configs:
      - targets:
          - 'pushgateway:9091'

  - job_name: 'rabbitmq'
    static_configs:
      - targets:
          - 'rabbitmq-exporter:9419'

  - job_name: 'mongodb'
    static_configs:
      - targets:
          - 'mongodb-exporter:9216'

  - job_name: 'mongo-doc-count'
    static_configs:
      - targets:
          - 'mongo-doc-count-exporter:9500'

  - job_name: 'cadvisor'
    static_configs:
      - targets:
          - 'cadvisor:8080'
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'cadvisor'
    metric_relabel_configs:
      # Extract service name from container_label_com_docker_compose_service
      - source_labels: [container_label_com_docker_compose_service]
        target_label: name
        regex: '^(.+)$'
        replacement: '$1'

  - job_name: 'qdrant'
    static_configs:
      - targets:
          - 'qdrant-exporter:9501'
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'qdrant-exporter'

  - job_name: 'document-processing'
    static_configs:
      - targets:
          - 'document-processing-exporter:9502'
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'document-processing-exporter'

