# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Copilot-for-Consensus contributors

# Root-level configuration for Python validation tools
# This file enables strict static type checking and linting for the entire project

[tool.ruff]
# Same as Black.
line-length = 120

# Target Python 3.10+
target-version = "py310"

# Exclude a variety of commonly ignored directories.
exclude = [
    ".bzr",
    ".direnv",
    ".eggs",
    ".git",
    ".git-rewrite",
    ".hg",
    ".mypy_cache",
    ".nox",
    ".pants.d",
    ".pytype",
    ".ruff_cache",
    ".svn",
    ".tox",
    ".venv",
    "__pypackages__",
    "_build",
    "buck-out",
    "build",
    "dist",
    "node_modules",
    "venv",
    "htmlcov",
]

[tool.ruff.lint]
# Enable pycodestyle (`E`) and Pyflakes (`F`) codes by default.
# Also enable import sorting (`I`), unused arguments (`ARG`), and undefined names (`F821`)
select = ["E", "F", "W", "I", "ARG", "UP"]
ignore = []

# Allow autofix for all enabled rules (when `--fix`) is provided.
fixable = ["ALL"]
unfixable = []

[tool.ruff.lint.per-file-ignores]
# Ignore import order in __init__.py files
"__init__.py" = ["F401", "E402"]
# Ignore unused arguments and long lines in test files
"test_*.py" = ["ARG001", "ARG002", "ARG005", "E501"]
"**/tests/**" = ["ARG001", "ARG002", "ARG005", "E501"]
# Ignore conftest.py fixture patterns
"conftest.py" = ["ARG001", "ARG002", "ARG005"]

[tool.mypy]
# Enable important type checking without being overly strict
# This catches real bugs while allowing incremental type adoption
python_version = "3.10"
warn_return_any = false  # Too noisy for existing codebase
warn_unused_configs = true
disallow_untyped_defs = false  # Allow gradual typing adoption
disallow_any_unimported = false
no_implicit_optional = true  # Catch None issues
warn_redundant_casts = true
warn_unused_ignores = false  # Don't fail on unused ignores
warn_no_return = true  # Catch missing returns
check_untyped_defs = false  # Don't check inside untyped functions
strict_equality = false  # Allow type mismatches in comparisons (too strict for gradual typing)
disallow_untyped_calls = false  # Allow calling untyped functions
disallow_incomplete_defs = false  # Allow partially typed functions
disallow_any_generics = false  # Don't require list[str], dict[str, str], etc.
warn_unreachable = false  # Don't warn about unreachable code (too many false positives)

# Per-module configuration
[[tool.mypy.overrides]]
module = [
    "pymongo.*",
    "pika.*",
    "qdrant_client.*",
    "prometheus_client.*",
    "uvicorn.*",
    "fastapi.*",
    "pydantic.*",
    "azure.*",
    "sentence_transformers.*",
    "openai.*",
    "transformers.*",
    "torch.*",
    "faiss.*",
    "sentry_sdk.*",
    "opentelemetry.*",
    "imapclient.*",
]
ignore_missing_imports = true

# Internal copilot packages - ignore missing imports for cross-package references
# This allows MyPy to check each package independently without requiring all to be in PYTHONPATH
[[tool.mypy.overrides]]
module = [
    "copilot_config.*",
    "copilot_schema_validation.*",
    "copilot_logging.*",
    "copilot_secrets.*",
    "copilot_archive_fetcher.*",
    "copilot_archive_store.*",
    "copilot_auth.*",
    "copilot_chunking.*",
    "copilot_consensus.*",
    "copilot_draft_diff.*",
    "copilot_embedding.*",
    "copilot_error_reporting.*",
    "copilot_event_retry.*",
    "copilot_message_bus.*",
    "copilot_metrics.*",
    "copilot_storage.*",
    "copilot_summarization.*",
    "copilot_vectorstore.*",
    "copilot_startup.*",
]
ignore_missing_imports = true

[tool.pyright]
# Pyright strict mode - catches attribute errors and missing fields
extraPaths = [
    "adapters/copilot_config",
    "adapters/copilot_auth",
    "adapters/copilot_archive_fetcher",
    "adapters/copilot_archive_store",
    "adapters/copilot_chunking",
    "adapters/copilot_consensus",
    "adapters/copilot_draft_diff",
    "adapters/copilot_embedding",
    "adapters/copilot_error_reporting",
    "adapters/copilot_event_retry",
    "adapters/copilot_logging",
    "adapters/copilot_message_bus",
    "adapters/copilot_metrics",
    "adapters/copilot_schema_validation",
    "adapters/copilot_secrets",
    "adapters/copilot_startup",
    "adapters/copilot_storage",
    "adapters/copilot_summarization",
    "adapters/copilot_vectorstore",
]
pythonVersion = "3.10"
typeCheckingMode = "basic"  # Start with basic, can move to "strict" gradually
reportMissingImports = true
reportMissingTypeStubs = false
reportUnknownMemberType = false
reportUnknownArgumentType = false
reportUnknownVariableType = false
reportUnknownLambdaType = false
reportUnknownParameterType = false
reportUnnecessaryIsInstance = "warning"
reportUnnecessaryCast = "warning"
reportUnnecessaryComparison = "warning"
reportAttributeAccessIssue = "error"  # Critical: catch attribute errors
reportOptionalMemberAccess = "error"
reportOptionalSubscript = "error"
reportOptionalOperand = "error"

# Exclude directories that shouldn't be type-checked
exclude = [
    "**/__pycache__",
    "**/node_modules",
    "**/.venv",
    "**/venv",
    "**/dist",
    "**/build",
    "htmlcov",
]

[tool.pylint.main]
# Pylint configuration for catching attribute issues
py-version = "3.10"
jobs = 0  # Use all available CPUs

[tool.pylint.messages_control]
# Enable critical checks for missing attributes and members
enable = [
    "E0602",  # undefined-variable: Used when an undefined variable is accessed
    "E1101",  # no-member: Used when a variable is accessed for a nonexistent member
    "E0611",  # no-name-in-module: Used when a name cannot be found in a module
    "E1102",  # not-callable: Used when an object being called has been inferred to a non-callable object
    "E1120",  # no-value-for-parameter: Used when a function call passes too few arguments
    "E1121",  # too-many-function-args: Used when a function call passes too many positional arguments
]

# Disable overly strict or noisy checks
disable = [
    "C0111",  # missing-docstring
    "C0103",  # invalid-name
    "R0903",  # too-few-public-methods
    "R0913",  # too-many-arguments
    "W0212",  # protected-access
]

[tool.pylint.format]
max-line-length = 120

[tool.pytest.ini_options]
# Pytest configuration
testpaths = ["tests"]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
addopts = "-v --strict-markers"
markers = [
    "integration: marks tests as integration tests",
    "unit: marks tests as unit tests",
]
