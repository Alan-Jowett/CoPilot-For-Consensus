# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Copilot-for-Consensus contributors

# Application Services
# This file contains all application microservices.
# Included by the top-level docker-compose.yml.

services:
  chunking:
    image: copilot-chunking:latest
    build:
      context: .
      dockerfile: ./chunking/Dockerfile
    environment:
      - SERVICE_VERSION=0.1.0
      - SCHEMA_DIR=/app/docs/schemas/configs
      - MESSAGE_BUS_TYPE=rabbitmq
      - RABBITMQ_HOST=messagebus
      - RABBITMQ_PORT=5672
      - DOCUMENT_STORE_TYPE=mongodb
      - MONGODB_HOST=documentdb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=copilot
      - METRICS_TYPE=${METRICS_TYPE:-noop}
      - PROMETHEUS_PUSHGATEWAY=${PROMETHEUS_PUSHGATEWAY:-http://pushgateway:9091}
      - ERROR_REPORTER_TYPE=${ERROR_REPORTER_TYPE:-console}
      - CHUNK_ERROR_REPORTER_TYPE=${CHUNK_ERROR_REPORTER_TYPE:-console}
      - CHUNKER_TYPE=${CHUNKER_TYPE:-token_window}
      - CHUNK_SIZE_TOKENS=${CHUNK_SIZE_TOKENS:-384}
      - CHUNK_OVERLAP_TOKENS=${CHUNK_OVERLAP_TOKENS:-50}
      - CHUNK_MAX_SIZE_TOKENS=${CHUNK_MAX_SIZE_TOKENS:-512}
      - CHUNK_MIN_SIZE_TOKENS=${CHUNK_MIN_SIZE_TOKENS:-100}
      - CHUNK_RETRY_MAX_ATTEMPTS=${CHUNK_RETRY_MAX_ATTEMPTS:-3}
      - CHUNK_HTTP_PORT=${CHUNK_HTTP_PORT:-8000}
      - SECRET_PROVIDER_TYPE=${SECRET_PROVIDER_TYPE:-local}
      - LOCAL_SECRETS_BASE_PATH=${LOCAL_SECRETS_BASE_PATH:-/run/secrets}
      # Authentication configuration
      - AUTH_SERVICE_URL=http://auth:8090
      - SERVICE_AUDIENCE=copilot-for-consensus
      - JWT_AUTH_ENABLED=${JWT_AUTH_ENABLED:-true}
    secrets:
      - rabbitmq_user
      - rabbitmq_password
      - mongodb_user
      - mongodb_password
    volumes:
      - ./adapters/copilot_auth:/app/adapters/copilot_auth:ro
    depends_on:
      messagebus:
        condition: service_healthy
      documentdb:
        condition: service_healthy
      auth:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s
    restart: unless-stopped

  embedding:
    image: copilot-embedding:latest
    build:
      context: .
      dockerfile: ./embedding/Dockerfile
    environment:
      - SERVICE_VERSION=0.1.0
      - SCHEMA_DIR=/app/docs/schemas/configs
      - MESSAGE_BUS_TYPE=rabbitmq
      - RABBITMQ_HOST=messagebus
      - RABBITMQ_PORT=5672
      - DOCUMENT_STORE_TYPE=mongodb
      - MONGODB_HOST=documentdb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=copilot
      - VECTOR_STORE_TYPE=qdrant
      - QDRANT_HOST=vectorstore
      - QDRANT_PORT=6333
      - EMBEDDING_BATCH_SIZE=${EMBEDDING_BATCH_SIZE:-32}
      - EMBEDDING_ENABLE_CACHE=${EMBEDDING_ENABLE_CACHE:-true}
      - EMBEDDING_CACHE_TTL_SECONDS=${EMBEDDING_CACHE_TTL_SECONDS:-86400}
      - EMBEDDING_HTTP_PORT=${EMBEDDING_HTTP_PORT:-8000}
      - EMBEDDING_RETRY_MAX_ATTEMPTS=${EMBEDDING_RETRY_MAX_ATTEMPTS:-3}
      - EMBEDDING_REQUEST_TIMEOUT_SECONDS=${EMBEDDING_REQUEST_TIMEOUT_SECONDS:-30}
      - EMBEDDING_BACKEND_TYPE=${EMBEDDING_BACKEND_TYPE:-sentencetransformers}
      - SENTENCETRANSFORMERS_MODEL_NAME=${SENTENCETRANSFORMERS_MODEL_NAME:-all-MiniLM-L6-v2}
      - SENTENCETRANSFORMERS_DEVICE=${SENTENCETRANSFORMERS_DEVICE:-cpu}
      - OLLAMA_HOST=http://ollama:11434
      - METRICS_TYPE=${METRICS_TYPE:-prometheus_pushgateway}
      - PROMETHEUS_PUSHGATEWAY=pushgateway:9091
      - ERROR_REPORTER_TYPE=console
      - SECRET_PROVIDER_TYPE=${SECRET_PROVIDER_TYPE:-local}
      - LOCAL_SECRETS_BASE_PATH=${LOCAL_SECRETS_BASE_PATH:-/run/secrets}
      # Authentication configuration
      - AUTH_SERVICE_URL=http://auth:8090
      - SERVICE_AUDIENCE=copilot-for-consensus
      - JWT_AUTH_ENABLED=${JWT_AUTH_ENABLED:-true}
    secrets:
      - rabbitmq_user
      - rabbitmq_password
      - mongodb_user
      - mongodb_password
    volumes:
      - ./adapters/copilot_auth:/app/adapters/copilot_auth:ro
    depends_on:
      messagebus:
        condition: service_healthy
      documentdb:
        condition: service_healthy
      vectorstore:
        condition: service_healthy
      auth:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s
    restart: unless-stopped

  ingestion:
    image: copilot-ingestion:latest
    build:
      context: .
      dockerfile: ./ingestion/Dockerfile
    environment:
      - SERVICE_VERSION=0.1.0
      - SCHEMA_DIR=/app/docs/schemas/configs
      - LOG_TYPE=stdout
      - LOG_LEVEL=INFO
      - MESSAGE_BUS_TYPE=rabbitmq
      - RABBITMQ_HOST=messagebus
      - RABBITMQ_PORT=5672
      - INGESTION_BATCH_SIZE=${INGESTION_BATCH_SIZE:-100}
      - INGESTION_CONCURRENT_SOURCES=${INGESTION_CONCURRENT_SOURCES:-5}
      - INGESTION_ENABLE_INCREMENTAL=${INGESTION_ENABLE_INCREMENTAL:-true}
      - INGESTION_RETRY_MAX_ATTEMPTS=${INGESTION_RETRY_MAX_ATTEMPTS:-3}
      - INGESTION_POLL_INTERVAL_SECONDS=${INGESTION_POLL_INTERVAL_SECONDS:-3600}
      - INGESTION_REQUEST_TIMEOUT_SECONDS=${INGESTION_REQUEST_TIMEOUT_SECONDS:-60}
      - METRICS_TYPE=${METRICS_TYPE:-prometheus_pushgateway}
      - PROMETHEUS_PUSHGATEWAY=pushgateway:9091
      - ERROR_REPORTER_TYPE=console
      - DOCUMENT_STORE_TYPE=mongodb
      - MONGODB_HOST=documentdb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=copilot
      - HTTP_HOST=0.0.0.0
      - INGESTION_HTTP_PORT=8001
      - SECRET_PROVIDER_TYPE=${SECRET_PROVIDER_TYPE:-local}
      - LOCAL_SECRETS_BASE_PATH=${LOCAL_SECRETS_BASE_PATH:-/run/secrets}
      # ArchiveStore configuration
      - ARCHIVE_STORE_TYPE=${ARCHIVE_STORE_TYPE:-local}
      - ARCHIVE_BASE_PATH=${ARCHIVE_BASE_PATH:-/data/raw_archives}
      # Authentication configuration
      - AUTH_SERVICE_URL=http://auth:8090
      - SERVICE_AUDIENCE=copilot-for-consensus
      - JWT_AUTH_ENABLED=${JWT_AUTH_ENABLED:-true}
    secrets:
      - rabbitmq_user
      - rabbitmq_password
      - mongodb_user
      - mongodb_password
    volumes:
      - raw_archives:/data/raw_archives
    depends_on:
      messagebus:
        condition: service_healthy
      monitoring:
        condition: service_healthy
      pushgateway:
        condition: service_healthy
      documentdb:
        condition: service_healthy
      auth:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s
    restart: "no"

  orchestrator:
    image: copilot-orchestrator:latest
    build:
      context: .
      dockerfile: ./orchestrator/Dockerfile
    environment:
      - SERVICE_VERSION=0.1.0
      - SCHEMA_DIR=/app/docs/schemas/configs
      - MESSAGE_BUS_TYPE=rabbitmq
      - RABBITMQ_HOST=messagebus
      - RABBITMQ_PORT=5672
      - DOCUMENT_STORE_TYPE=mongodb
      - MONGODB_HOST=documentdb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=copilot
      - LOG_TYPE=stdout
      - ORCHESTRATOR_CONSENSUS_TIMEOUT_SECONDS=${ORCHESTRATOR_CONSENSUS_TIMEOUT_SECONDS:-300}
      - ORCHESTRATOR_HTTP_PORT=${ORCHESTRATOR_HTTP_PORT:-8000}
      - ORCHESTRATOR_MAX_PARALLEL_REVIEWS=${ORCHESTRATOR_MAX_PARALLEL_REVIEWS:-10}
      - ORCHESTRATOR_RETRY_MAX_ATTEMPTS=${ORCHESTRATOR_RETRY_MAX_ATTEMPTS:-3}
      - ORCHESTRATOR_REQUEST_TIMEOUT_SECONDS=${ORCHESTRATOR_REQUEST_TIMEOUT_SECONDS:-60}
      - ORCHESTRATOR_WORKFLOW_HISTORY_RETENTION_DAYS=${ORCHESTRATOR_WORKFLOW_HISTORY_RETENTION_DAYS:-90}
      - QDRANT_HOST=vectorstore
      - QDRANT_PORT=6333
      - EMBEDDING_BACKEND_TYPE=${EMBEDDING_BACKEND_TYPE:-sentencetransformers}
      - SENTENCETRANSFORMERS_MODEL=${SENTENCETRANSFORMERS_MODEL:-all-MiniLM-L6-v2}
      - LLM_BACKEND=${LLM_BACKEND:-local}
      - OLLAMA_HOST=http://ollama:11434
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT:-}
      - METRICS_TYPE=${METRICS_TYPE:-prometheus_pushgateway}
      - PROMETHEUS_PUSHGATEWAY=pushgateway:9091
      - ERROR_REPORTER_TYPE=console
      - SECRET_PROVIDER_TYPE=${SECRET_PROVIDER_TYPE:-local}
      - LOCAL_SECRETS_BASE_PATH=${LOCAL_SECRETS_BASE_PATH:-/run/secrets}
      # Authentication configuration
      - AUTH_SERVICE_URL=http://auth:8090
      - SERVICE_AUDIENCE=copilot-for-consensus
      - JWT_AUTH_ENABLED=${JWT_AUTH_ENABLED:-true}
    secrets:
      - rabbitmq_user
      - rabbitmq_password
      - mongodb_user
      - mongodb_password
      - azure_openai_key
    volumes:
      - ./adapters/copilot_auth:/app/adapters/copilot_auth:ro
    depends_on:
      messagebus:
        condition: service_healthy
      documentdb:
        condition: service_healthy
      vectorstore:
        condition: service_healthy
      vectorstore-validate:
        condition: service_completed_successfully
      auth:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s
    restart: unless-stopped

  parsing:
    image: copilot-parsing:latest
    build:
      context: .
      dockerfile: ./parsing/Dockerfile
    environment:
      - SERVICE_VERSION=0.1.0
      - SCHEMA_DIR=/app/docs/schemas/configs
      - MESSAGE_BUS_TYPE=rabbitmq
      - RABBITMQ_HOST=messagebus
      - RABBITMQ_PORT=5672
      - DOCUMENT_STORE_TYPE=mongodb
      - MONGODB_HOST=documentdb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=copilot
      - LOG_TYPE=stdout
      - PARSING_HTTP_PORT=${PARSING_HTTP_PORT:-8000}
      - PARSING_LOG_LEVEL=${PARSING_LOG_LEVEL:-INFO}
      - PARSING_RETRY_MAX_ATTEMPTS=${PARSING_RETRY_MAX_ATTEMPTS:-3}
      - PARSING_RETRY_DELAY_SECONDS=${PARSING_RETRY_DELAY_SECONDS:-5}
      - METRICS_TYPE=${METRICS_TYPE:-prometheus_pushgateway}
      - PROMETHEUS_PUSHGATEWAY=pushgateway:9091
      - ERROR_REPORTER_TYPE=console
      - SECRET_PROVIDER_TYPE=${SECRET_PROVIDER_TYPE:-local}
      - LOCAL_SECRETS_BASE_PATH=${LOCAL_SECRETS_BASE_PATH:-/run/secrets}
      # ArchiveStore configuration
      - ARCHIVE_STORE_TYPE=${ARCHIVE_STORE_TYPE:-local}
      - ARCHIVE_BASE_PATH=${ARCHIVE_BASE_PATH:-/data/raw_archives}
      # Azure Blob Storage configuration (for azure_blob backend)
      # - AZUREBLOB_ACCOUNT=${AZUREBLOB_ACCOUNT}
      # - AZURE_STORAGE_KEY=${AZURE_STORAGE_KEY}
      # - AZUREBLOB_STORAGE_CONTAINER=${AZUREBLOB_STORAGE_CONTAINER:-archives}
      # Authentication configuration
      - AUTH_SERVICE_URL=http://auth:8090
      - SERVICE_AUDIENCE=copilot-for-consensus
      - JWT_AUTH_ENABLED=${JWT_AUTH_ENABLED:-true}
    secrets:
      - rabbitmq_user
      - rabbitmq_password
      - mongodb_user
      - mongodb_password
    volumes:
      - raw_archives:/data/raw_archives:ro
      - ./adapters/copilot_auth:/app/adapters/copilot_auth:ro
    depends_on:
      messagebus:
        condition: service_healthy
      documentdb:
        condition: service_healthy
      auth:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  reporting:
    image: copilot-reporting:latest
    build:
      context: .
      dockerfile: ./reporting/Dockerfile
    environment:
      - SERVICE_VERSION=0.1.0
      - SCHEMA_DIR=/app/docs/schemas/configs
      - MESSAGE_BUS_TYPE=rabbitmq
      - RABBITMQ_HOST=messagebus
      - RABBITMQ_PORT=5672
      - DOCUMENT_STORE_TYPE=mongodb
      - MONGODB_HOST=documentdb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=copilot
      - VECTOR_STORE_TYPE=qdrant
      - QDRANT_HOST=vectorstore
      - QDRANT_PORT=6333
      - QDRANT_COLLECTION=embeddings
      - LOG_TYPE=stdout
      - REPORTING_HTTP_PORT=${REPORTING_HTTP_PORT:-8080}
      - REPORTING_NOTIFY_ENABLED=${REPORTING_NOTIFY_ENABLED:-false}
      - REPORTING_NOTIFY_WEBHOOK_URL=${REPORTING_NOTIFY_WEBHOOK_URL:-}
      - REPORTING_WEBHOOK_SUMMARY_MAX_LENGTH=${REPORTING_WEBHOOK_SUMMARY_MAX_LENGTH:-500}
      - EMBEDDING_BACKEND_TYPE=${EMBEDDING_BACKEND_TYPE:-sentencetransformers}
      - SENTENCETRANSFORMERS_MODEL=${SENTENCETRANSFORMERS_MODEL:-all-MiniLM-L6-v2}
      - SENTENCETRANSFORMERS_SENTENCETRANSFORMERS_DEVICE=${SENTENCETRANSFORMERS_SENTENCETRANSFORMERS_DEVICE:-cpu}
      - METRICS_TYPE=${METRICS_TYPE:-noop}
      - PROMETHEUS_PUSHGATEWAY=${PROMETHEUS_PUSHGATEWAY:-http://pushgateway:9091}
      - ERROR_REPORTER_TYPE=console
      - SECRET_PROVIDER_TYPE=${SECRET_PROVIDER_TYPE:-local}
      - LOCAL_SECRETS_BASE_PATH=${LOCAL_SECRETS_BASE_PATH:-/run/secrets}
      # Authentication configuration
      - AUTH_SERVICE_URL=http://auth:8090
      - SERVICE_AUDIENCE=copilot-for-consensus
      - JWT_AUTH_ENABLED=${JWT_AUTH_ENABLED:-true}
    secrets:
      - rabbitmq_user
      - rabbitmq_password
      - mongodb_user
      - mongodb_password
    volumes:
      - ./adapters/copilot_auth:/app/adapters/copilot_auth:ro
    # Reporting service listens on internal port 8080 within the Docker network
    # External access is via the API Gateway's host port 8080 at the /reporting path
    # No direct host port mapping here to avoid conflict with gateway's :8080
    depends_on:
      messagebus:
        condition: service_healthy
      documentdb:
        condition: service_healthy
      vectorstore:
        condition: service_healthy
      auth:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s
    restart: unless-stopped

  auth:
    image: copilot-auth:latest
    build:
      context: .
      dockerfile: ./auth/Dockerfile
    environment:
      - SERVICE_VERSION=0.1.0
      - LOG_TYPE=${LOG_TYPE:-stdout}
      - AUTH_ISSUER=${AUTH_ISSUER:-http://localhost:8080/ui}
      - AUTH_AUDIENCES=${AUTH_AUDIENCES:-copilot-for-consensus}
      - AUTH_JWT_ALGORITHM=${AUTH_JWT_ALGORITHM:-RS256}
      - AUTH_JWT_KEY_ID=${AUTH_JWT_KEY_ID:-default}
      - AUTH_JWT_DEFAULT_EXPIRY=${AUTH_JWT_DEFAULT_EXPIRY:-1800}
      - SECRET_PROVIDER_TYPE=${SECRET_PROVIDER_TYPE:-local}
      - LOCAL_SECRETS_BASE_PATH=${LOCAL_SECRETS_BASE_PATH:-/run/secrets}
      - METRICS_TYPE=noop
      - AUTH_ROLE_STORE_TYPE=${AUTH_ROLE_STORE_TYPE:-mongodb}
      # Role store (MongoDB) connection for auth credentials
      - AUTH_MONGODB_HOST=documentdb
      - AUTH_MONGODB_PORT=27017
      - AUTH_MONGODB_DATABASE=auth
      - AUTH_MONGODB_COLLECTION=user_roles
      - AUTH_ROLE_STORE_SCHEMA_DIR=/app/docs/schemas/role_store
      # OIDC Providers - OAuth secrets read via copilot_secrets from /run/secrets
      - GITHUB_REDIRECT_URI=${GITHUB_REDIRECT_URI:-https://localhost/ui/callback}
      - GOOGLE_REDIRECT_URI=${GOOGLE_REDIRECT_URI:-https://localhost/ui/callback}
      - MICROSOFT_REDIRECT_URI=${MICROSOFT_REDIRECT_URI:-https://localhost/ui/callback}
      - MICROSOFT_TENANT=${MICROSOFT_TENANT:-common}
      # Security
      - AUTH_REQUIRE_PKCE=${AUTH_REQUIRE_PKCE:-true}
      - AUTH_REQUIRE_NONCE=${AUTH_REQUIRE_NONCE:-true}
      - AUTH_MAX_SKEW_SECONDS=${AUTH_MAX_SKEW_SECONDS:-90}
      - AUTH_FIRST_USER_AUTO_PROMOTION_ENABLED=${AUTH_FIRST_USER_AUTO_PROMOTION_ENABLED:-false}
      # Cookie security - Set COOKIE_SECURE=true in production (HTTPS)
      - COOKIE_SECURE=${COOKIE_SECURE:-false}
      - PORT=8090
      - HOST=0.0.0.0
      # Bootstrap token for initial admin setup (one-time use)
      - BOOTSTRAP_TOKEN=${BOOTSTRAP_TOKEN:-}
    volumes:
      - ./adapters/copilot_auth:/app/adapters/copilot_auth:ro
      - ./adapters/copilot_logging:/app/adapters/copilot_logging:ro
      - ./adapters/copilot_metrics:/app/adapters/copilot_metrics:ro
    secrets:
      - jwt_private_key
      - jwt_public_key
      - jwt_secret_key
      - github_oauth_client_id
      - github_oauth_client_secret
      - google_oauth_client_secret
      - microsoft_oauth_client_secret
      - role_store_password
      - mongodb_user
      - mongodb_password
    depends_on:
      documentdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8090/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  # React-based SPA (primary Web UI)
  ui:
    image: copilot-ui:latest
    build:
      context: ./ui
      dockerfile: Dockerfile
      args:
        - VITE_GRAFANA_ENABLED=true
    # No host port; UI served via API Gateway at /ui/
    depends_on:
      reporting:
        condition: service_healthy
    healthcheck:
      # File check is sufficient for static content; wget not available in nginx:alpine
      test: ["CMD-SHELL", "test -f /usr/share/nginx/html/index.html || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
    restart: unless-stopped

  summarization:
    image: copilot-summarization:latest
    build:
      context: .
      dockerfile: ./summarization/Dockerfile
    environment:
      - SERVICE_VERSION=0.1.0
      - SCHEMA_DIR=/app/docs/schemas/configs
      - MESSAGE_BUS_TYPE=rabbitmq
      - RABBITMQ_HOST=messagebus
      - RABBITMQ_PORT=5672
      - DOCUMENT_STORE_TYPE=mongodb
      - MONGODB_HOST=documentdb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=copilot
      - LOG_TYPE=stdout
      - VECTOR_STORE_TYPE=qdrant
      - QDRANT_HOST=vectorstore
      - QDRANT_PORT=6333
      - EMBEDDING_BACKEND_TYPE=${EMBEDDING_BACKEND_TYPE:-sentencetransformers}
      - SENTENCETRANSFORMERS_MODEL=${SENTENCETRANSFORMERS_MODEL:-all-MiniLM-L6-v2}
      - LLM_BACKEND_TYPE=${LLM_BACKEND_TYPE:-local}
      - LLM_MODEL=${LLM_MODEL:-mistral}
      - LOCAL_LLM_ENDPOINT=${LOCAL_LLM_ENDPOINT:-http://ollama:11434}
      - LLM_TIMEOUT_SECONDS=${LLM_TIMEOUT_SECONDS:-300}
      - METRICS_TYPE=${METRICS_TYPE:-prometheus_pushgateway}
      - PROMETHEUS_PUSHGATEWAY=pushgateway:9091
      - ERROR_REPORTER_TYPE=console
      - SECRET_PROVIDER_TYPE=${SECRET_PROVIDER_TYPE:-local}
      - LOCAL_SECRETS_BASE_PATH=${LOCAL_SECRETS_BASE_PATH:-/run/secrets}
      # Authentication configuration
      - AUTH_SERVICE_URL=http://auth:8090
      - SERVICE_AUDIENCE=copilot-for-consensus
      - JWT_AUTH_ENABLED=${JWT_AUTH_ENABLED:-true}
    secrets:
      - rabbitmq_user
      - rabbitmq_password
      - mongodb_user
      - mongodb_password
    volumes:
      - ./adapters/copilot_auth:/app/adapters/copilot_auth:ro
    depends_on:
      messagebus:
        condition: service_healthy
      documentdb:
        condition: service_healthy
      vectorstore:
        condition: service_healthy
      vectorstore-validate:
        condition: service_completed_successfully
      auth:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s
    restart: unless-stopped

  retry-job:
    image: copilot-retry-job:latest
    build:
      context: .
      dockerfile: ./scripts/Dockerfile.retry-job
    environment:
      - MONGODB_HOST=documentdb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=${MONGO_APP_DB:-copilot}
      - RABBITMQ_HOST=messagebus
      - RABBITMQ_PORT=5672
      - PUSHGATEWAY_URL=http://pushgateway:9091
      - RETRY_JOB_INTERVAL_SECONDS=${RETRY_JOB_INTERVAL_SECONDS:-900}
      - RETRY_JOB_BASE_DELAY_SECONDS=${RETRY_JOB_BASE_DELAY_SECONDS:-300}
      - RETRY_JOB_MAX_DELAY_SECONDS=${RETRY_JOB_MAX_DELAY_SECONDS:-3600}
      - RETRY_JOB_STUCK_THRESHOLD_HOURS=${RETRY_JOB_STUCK_THRESHOLD_HOURS:-24}
      - SECRET_PROVIDER_TYPE=${SECRET_PROVIDER_TYPE:-local}
      - LOCAL_SECRETS_BASE_PATH=${LOCAL_SECRETS_BASE_PATH:-/run/secrets}
    secrets:
      - rabbitmq_user
      - rabbitmq_password
      - mongodb_user
      - mongodb_password
    depends_on:
      documentdb:
        condition: service_healthy
      messagebus:
        condition: service_healthy
      pushgateway:
        condition: service_healthy
    restart: unless-stopped
